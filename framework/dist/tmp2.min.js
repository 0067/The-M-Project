// ==========================================================================
// Project:   The M-Project - Mobile HTML5 Application Framework
// Version:   0.0.1
// Copyright: (c) 2013 M-Way Solutions GmbH. All rights reserved.
// Date:      Mon Sep 30 2013 09:43:54
// License:   Dual licensed under the MIT or GPL Version 2 licenses.
//            http://github.com/mwaylabs/The-M-Project/blob/master/MIT-LICENSE
//            http://github.com/mwaylabs/The-M-Project/blob/master/GPL-LICENSE
// ==========================================================================
var M=function(a,b,c){var d={};!function(){return d={},d.Version=d.version="2.0",d.f=function(){},d.create=function(a){return new this(a)},d.isCollection=function(a){return b.Collection.prototype.isPrototypeOf(a)},d.isModel=function(a){return b.Model.prototype.isPrototypeOf(a)},YES=!0,NO=!1,d}(),d.CONST={LOGGER:{TAG_FRAMEWORK_CORE:"framework-core",TAG_FRAMEWORK_DATA:"framework-data",TAG_FRAMEWORK_UI:"framework-ui",TAG_FRAMEWORK_UTILITY:"framework-utility",TAG_ALL:""},TYPE:{INTEGER:"integer",STRING:"string",TEXT:"text",DATE:"date",BOOLEAN:"boolean",FLOAT:"float",OBJECT:"object",ARRAY:"array",BINARY:"binary",OBJECTID:"objectid",NULL:"null"},ORDER:{ASC:"ASC",DESC:"DESC"},ERROR:{UNDEFINED:0,CONNECTION:1,VALIDATION_PRESENCE:100,VALIDATION_URL:101,VALIDATION_PHONE:102,VALIDATION_NUMBER:103,VALIDATION_NOTMINUS:104,VALIDATION_EMAIL:105,VALIDATION_DATE:106,MODEL_PROVIDER_NOT_SET:120,WEBSQL_UNKNOWN:200,WEBSQL_DATABASE:201,WEBSQL_VERSION:202,WEBSQL_TOO_LARGE:203,WEBSQL_QUOTA:204,WEBSQL_SYNTAX:205,WEBSQL_CONSTRAINT:206,WEBSQL_TIMEOUT:207,WEBSQL_NO_DBHANDLER:208,WEBSQL_NOT_SUPPORTED:209,WEBSQL_BULK_NO_RECORDS:210,COUCHDB_CONFLICT:300,COUCHDB_DBNOTFOUND:301,COUCHDB_DBEXISTS:302,COUCHDB_DOCNOTFOUND:303},INPUT:{TEXT:"text",PASSWORD:"password",NUMBER:"number",TELEPHONE:"tel",URL:"url",EMAIL:"email",TIME:"time",DATE:"date",DATETIME:"datetime",MONTH:"month",WEEK:"week"}},d.Object={_type:"M.Object",_lastThis:null,_implementedInterfaces:null,_create:function(a){var b=function(){};return b.prototype=a,new b},include:function(a){for(var b in a){if(this.hasOwnProperty(b))throw d.Exception.RESERVED_WORD.getException();this[b]=a[b]}return this},extend:function(a){var b=this._create(this);return b.include(this._normalize(a)),b._init(),c.each(b._implementedInterfaces,function(a){b.bindToCaller(b,a._init)()},b),b},implement:function(a){if(a&&a.isMInterface){var b=a.getInterface();c.each(b,function(a,d){c.contains(this.keys(),d)&&(b[d]=null,delete b[d])},this),this.include(b),this._implementedInterfaces=this._implementedInterfaces||[],this._implementedInterfaces.push(a)}return this},hasInterfaceImplementation:function(a){var b=NO;return c.each(this._implementedInterfaces,function(c){a===c&&(b=YES)},this),b},bindToCaller:function(a,b,c){return function(){if("function"!=typeof b||"object"!=typeof a)throw d.Exception.INVALID_INPUT_PARAMETER.getException();return Array.isArray(c)?b.apply(a,c):b.call(a,c)}},_init:function(){},_normalize:function(a){return a=a&&"object"==typeof a?a:{}},handleCallback:function(a){var b=Array.prototype.slice.call(arguments,1);if(a){var c="object"==typeof a.target?a.target:this,d=a;if("function"==typeof a.action?d=a.action:"string"==typeof a.action&&(d=c[a.action]),"function"==typeof d)return this.bindToCaller(c,d,b)()}},callFromSuper:function(a,b){var e=Object.getPrototypeOf(this);return d.Object._lastThis===this?e=Object.getPrototypeOf(e):d.Object._lastThis=this,this.bindToCaller(this,e[a],c.isArray(b)?b:[b])()},defineHiddenProperty:function(a,b){this.defineProperty(a,b,{writable:YES,enumerable:NO,configurable:YES})},defineReadonlyProperty:function(a,b){this.defineProperty(a,b,{writable:NO,enumerable:YES,configurable:YES})},defineProperty:function(a,b,c){c=c||{},Object.defineProperty(this,a,{writable:!!c.writable,enumerable:!!c.enumerable,configurable:!!c.configurable,value:b})},getObjectType:function(){return this._type}},d.Logger=d.Object.extend({filter:[],_type:"M.Logger",_OUTPUT_LOG:0,_OUTPUT_DEBUG:1,_OUTPUT_WARN:2,_OUTPUT_ERROR:3,_LEVEL_TIME_END:4,_times:[],_counts:[],_appRunsInNotDebugMode:NO,_init:function(){c.isUndefined(console)&&(window.console={},console.log=console.debug=console.warn=console.error=function(){}),this._appRunsInNotDebugMode=NO},log:function(){this._print(this._OUTPUT_LOG,arguments)},warn:function(){this._print(this._OUTPUT_WARN,arguments)},error:function(a,b){this._print(this._OUTPUT_ERROR,b,a)},time:function(a){return this._appRunsInNotDebugMode?void 0:c.isUndefined(console.time2)?(this._time(a),void 0):(console.time(a),void 0)},timeEnd:function(a){return this._appRunsInNotDebugMode?void 0:c.isUndefined(console.timeEnd2)?(this._timeEnd(a),void 0):(console.timeEnd(a),void 0)},count:function(a){return this._appRunsInNotDebugMode?void 0:c.isUndefined(console.count2)?(this._count(a),void 0):(console.count(a),void 0)},_print:function(a,b){if(!this._appRunsInNotDebugMode){a=a||this._OUTPUT_LOG,b=Array.prototype.slice.call(b),1==b.length&&b.splice(0,0,d.CONST.LOGGER.TAG_ALL);var e=b[0];if(!this._preventOutputByTag(e)){var f="";if(a<this._OUTPUT_ERROR)if(c.isArray(e)&&this.filter.length>0){var g=c.without(this.filter,e);f="["+g+"]"}else e.length>0&&(f="["+e+"]");switch(b.length>1&&(f==d.CONST.LOGGER.TAG_ALL?b.splice(0,1):b[0]=f),a){case this._OUTPUT_LOG:console.log.apply(console,b);break;case this._OUTPUT_WARN:b.splice(0,0,"WARNING:"),console.warn.apply(console,b);break;case this._OUTPUT_ERROR:b.splice(0,0,"ERROR:"),console.error.apply(console,b);break;case this._OUTPUT_DEBUG:console.debug.apply(console,b);break;default:console.log.apply(console,b)}}}},_time:function(a){var b=c.find(this._times,function(b){return b.label===a});b||this._times.push({label:a,time:(new Date).getTime()})},_timeEnd:function(a){var b=c.find(this._times,function(b){return b.label===a});if(b){var d=(new Date).getTime(),e=(d-b.time)/1e3,f=this._times.indexOf(b);this._print(this._OUTPUT_DEBUG,[b.label+": "+e+"ms"]),this._times.splice(f,1)}},_count:function(a){var b=c.find(this._counts,function(b){return b.label===a});void 0===b?(this._counts.push({label:a,count:1}),b=c.last(this._counts)):b.count++,this._print(this._OUTPUT_DEBUG,[b.label+": "+b.count])},_preventOutputByTag:function(a){if(this.filter.length>0&&-1===this.filter.indexOf(d.CONST.TAG_ALL))if(c.isString(a)){if(-1===this.filter.indexOf(a))return YES}else if(c.isArray(a)&&c.difference(a,this.filter).length===a.length)return YES;return NO}}),d.ViewManager=d.Object.extend({_type:"M.ViewManager",nextId:0,idPrefix:"m_",_views:null,_foundView:null,getNewId:function(a){this.nextId=this.nextId+1;var b=this.idPrefix+this.nextId;return this.addView(a,b),b},addView:function(a,b){b||(b=a.cid),this._views[b]=a},_init:function(){this.callFromSuper("_init"),this._views={}},getViewById:function(a){return this._views[a]},getView:function(a,b){return a.isMView&&a.hasChildViews()?(this._foundView=null,this._findView(a,b),this._foundView||d.Logger.warn(d.CONST.LOGGER.TAG_FRAMEWORK_UI,"The view '"+b+"' could not be found."),this._foundView):(d.Logger.warn(d.CONST.LOGGER.TAG_FRAMEWORK_UI,"The given parentView in M.ViewManager.getView() is no valid view or does not provide any child views."),null)},_findView:function(a,b){if(a.isMView&&a.hasChildViews()){var c=a._getChildViewsAsArray();for(var d in c){var e=c[d];b===e?this._foundView=a[e]:this._findView(a[e],b)}}},deleteView:function(a){a&&a.isMView&&a.getId()&&delete this._views[a.getId()]}}),d.Application=function(a){this.initialize(a)},b.Layout.configure({manage:!0}),d.Application.create=d.create,c.extend(d.Application.prototype,b.Events,{_type:"M.Application",router:null,initialize:function(a){return a&&a.applicationName&&(window.TMP_APPLICATION_NAME=a.applicationName),window[window.TMP_APPLICATION_NAME]=this,this},start:function(a){return a.router||console.warn("no router was given to the app start"),this.router=a.router,b.history.start(),this},initialRender:function(){this.layoutManager.initialRenderProcess()}}),d.I18N=d.Object.extend({_type:"M.I18N",_defaultLanguageCode:"",_currentLanguageCode:"",_currentLanguage:null,_languages:{},_languageMapper:{en:"en_us",de:"de_de"},l:function(a,b){return this._localize(a,b)},setCurrentLanguageCode:function(a){return a&&a==this._currentLanguageCode?(d.Logger.log(d.CONST.LOGGER.TAG_FRAMEWORK_UTILITY,"Language '"+a+"' already selected"),void 0):(this.isLanguageAvailable(a)?this._currentLanguageCode=a:(d.Logger.warn(d.CONST.LOGGER.TAG_FRAMEWORK_UTILITY,"There is no language '"+a+"' specified using default language '"+this._defaultLanguageCode+"' instead!"),this._currentLanguageCode=this._defaultLanguageCode),this._resetCurrentLanguage(),void 0)},getCurrentLanguageCode:function(){var a=null;if(a)return a;if(navigator){var b=/([a-zA-Z]{2,3})[\s_.-]?([a-zA-Z]{2,3})?/.exec(navigator.language);if(b&&this[b[0]])return b[0].toLowerCase();if(b&&b[1]&&this._languageMapper[b[1]]){var a=this._languageMapper[b[1]];return a.toLowerCase()}return this._defaultLanguageCode}return this._defaultLanguageCode},setDefaultLanguageCode:function(a){this._defaultLanguageCode=a},addLanguage:function(a,b){var d=this._parseObject(b);this._languages[a]=c.extend({},this._languages[a],d),this._resetCurrentLanguage()},getAvailableLanguages:function(){var a=[];for(key in this._languages)a.push(key);return a},isLanguageAvailable:function(a){var b=this._languages[a];return b&&c.isObject(b)?YES:(d.Logger.warn(d.CONST.LOGGER.TAG_FRAMEWORK_UTILITY,"No language '"+a+"' specified."),NO)},_getLanguage:function(a){return this.isLanguageAvailable(a)?this._languages[a]:this._languages[this._defaultLanguageCode]},_localize:function(a,b){var e;this._currentLanguage||(this._currentLanguage=this._getLanguage(this._currentLanguageCode));var e=this._currentLanguage[a];if(!e){var f=this._getLanguage(this._defaultLanguageCode);f&&f[a]&&(d.Logger.log(d.CONST.LOGGER.TAG_FRAMEWORK_UTILITY,"Key '"+a+"' not defined for language '"+this._currentLanguageCode+"', switched to default language '"+this._defaultLanguageCode+"'"),e=f[a])}if(e||(d.Logger.log(d.CONST.LOGGER.TAG_FRAMEWORK_UTILITY,"Key '"+a+"' not defined for both language '"+this._currentLanguageCode+"' and the system's default language '"+this._defaultLanguageCode+"'"),e=a),b)try{e=c.template(e,b)}catch(g){d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_UTILITY,'Error in I18N: Check your context object and the translation string with key "'+a+'". Error Message: ',g)}return e},_resetCurrentLanguage:function(){this._currentLanguage=null},_parseObject:function(a){var b={};for(var d in a)if(a.hasOwnProperty(d))if(c.isObject(a[d])){var e=this._parseObject(a[d]);for(var f in e)e.hasOwnProperty(f)&&(b[d+"."+f]=e[f])}else b[d]=a[d];return b}}),d.ObjectID=function(a){d.ObjectID.counter=d.ObjectID.counter||parseInt(Math.random()*Math.pow(16,6)),d.ObjectID.machineId=d.ObjectID.machineId||parseInt(Math.random()*Math.pow(16,6)),d.ObjectID.processId=d.ObjectID.processId||parseInt(Math.random()*Math.pow(16,4)),this._ObjectID(a)},d.ObjectID._looksLikeObjectID=function(a){return 24===a.length&&a.match(/^[0-9a-f]*$/)},c.extend(d.ObjectID.prototype,{_str:"",_ObjectID:function(a){if(a){if(a=a.toLowerCase(),!d.ObjectID._looksLikeObjectID(a))throw new Error("Invalid hexadecimal string for creating an ObjectID");this._str=a}else this._str=this._hexString(8,(new Date).getTime()/1e3)+this._hexString(6,d.ObjectID.machineId)+this._hexString(4,d.ObjectID.processId)+this._hexString(6,d.ObjectID.counter++);return this._str},_hexString:function(a,b){b=b||parseInt(Math.random()*Math.pow(16,a));for(var c=b.toString(16);c.length<a;)c="0"+c;return c.substr(0,a)},toString:function(){return'ObjectID("'+this._str+'")'},equals:function(a){return a instanceof this._ObjectID&&this.valueOf()===a.valueOf()},clone:function(){return new d.ObjectID(this._str)},typeName:function(){return"oid"},getTimestamp:function(){return 1e3*parseInt(this._str.substr(0,8),16)},getMachineId:function(){return parseInt(this._str.substr(8,6),16)},getProcessId:function(){return parseInt(this._str.substr(14,4),16)},getCounter:function(){return parseInt(this._str.substr(18,6),16)},valueOf:function(){return this._str},toJSON:function(){return this._str},toHexString:function(){return this._str},_selectorIsId:function(a){return"string"==typeof a||"number"==typeof a||a instanceof d.ObjectId},_selectorIsIdPerhapsAsObject:function(a){return this._selectorIsId(a)||a&&"object"==typeof a&&a._id&&this._selectorIsId(a._id)&&1===c.size(a)},_idsMatchedBySelector:function(a){if(this._selectorIsId(a))return[a];if(!a)return null;if(c.has(a,"_id"))return this._selectorIsId(a._id)?[a._id]:a._id&&a._id.$in&&c.isArray(a._id.$in)&&!c.isEmpty(a._id.$in)&&c.all(a._id.$in,this._selectorIsId)?a._id.$in:null;if(a.$and&&c.isArray(a.$and))for(var b=0;b<a.$and.length;++b){var d=this._idsMatchedBySelector(a.$and[b]);if(d)return d}return null}}),d.UniqueId=d.Object.extend({uuid:function(a,b){var c="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),d=[];b=b||c.length;var e;if(a)for(e=0;a>e;e++)d[e]=c[0|Math.random()*b];else{var f;for(d[8]=d[13]=d[18]=d[23]="-",d[14]="4",e=0;36>e;e++)d[e]||(f=0|16*Math.random(),d[e]=c[19==e?8|3&f:f])}return d.join("")}}),d.Request=d.Object.extend({_type:"M.Request",_id:null,_request:null,method:null,url:null,timeout:null,data:null,init:function(a){return this.extend(a)},_normalize:function(a){return a=a&&"object"==typeof a?a:{},a.callbacks=a.callbacks||{},a},_init:function(){if(Object.getPrototypeOf(this)===d.Request&&!this.url)throw d.Exception.NO_REQUEST_URL_SPECIFIED.getException();this._id=d.UniqueId.uuid(),this.method=this.method||"GET",this.data=this.data||"",("number"!=typeof this.timeout||this.timeout<0)&&delete this.timeout},getId:function(){return this._id},send:function(){this._request=$.ajax({type:this.method,url:this.url,timeout:this.timeout,data:this.data,context:this,beforeSend:this._handleBeforeSend,success:this._handleSuccess,error:this._handleError})},cancel:function(){this._request&&this._request.abort(),this._request=null},_handleBeforeSend:function(a){this.handleCallback(this.callbacks.beforeSend,{id:this.getId(),xhr:a})},_handleSuccess:function(a,b,c){this.handleCallback(this.callbacks.success,{id:this.getId(),data:a,status:b,xhr:c}),this.cancel()},_handleError:function(a,b,c){this.handleCallback(this.callbacks.error,{id:this.getId(),xhr:a,status:b,error:c}),this.cancel()},setAuthentication:function(a,b){if(b&&b.username&&a&&d.Base64){var c=d.Base64.encode(encodeURIComponent(b.username+":"+(b.password||"")));a.setRequestHeader("Authorization","Basic "+c)}},getLocation:function(a){var b=document.createElement("a");return b.href=a||this.url,""==b.host&&(b.href=b.href),b}}),d.RequestManager=d.Object.extend({_type:"M.RequestManager",baseUrl:null,method:null,timeout:null,_requests:null,init:function(a){return this.extend(a)},_normalize:function(a){return a=a&&"object"==typeof a?a:{},a.callbacks=a.callbacks||{},a.baseUrl=a.baseUrl||a.url,a},_init:function(){if(Object.getPrototypeOf(this)===d.RequestManager&&!this.baseUrl)throw d.Exception.NO_REQUEST_MANAGER_BASE_URL_SPECIFIED.getException();this._requests={},this.baseUrl&&this.baseUrl.lastIndexOf("/")===this.baseUrl.length-1&&(this.baseUrl=this.baseUrl.substr(0,this.baseUrl.length-1)),this.url&&delete this.url,this.method=this.method||"GET",("number"!=typeof this.timeout||this.timeout<0)&&delete this.timeout},doRequest:function(a){a=a&&"object"==typeof a?a:{};var b=d.Request.init({url:this.getUrl(a),timeout:isNaN(a.timeout)?this.timeout:a.timeout,method:a.method?a.method:this.method,data:a.data?a.data:"",callbacks:{beforeSend:{target:this,action:"_handleBeforeSend"},success:{target:this,action:"_handleSuccess"},error:{target:this,action:"_handleError"}}});return this._requests[b.getId()]=b,b.send(),b},getUrl:function(a){return a.path&&"/"!==a.path[0]&&(a.path="/"+a.path),this.baseUrl+(a.path?a.path:"")},_handleBeforeSend:function(a){this.handleCallback(this.callbacks.beforeSend,a)},_handleSuccess:function(a){this.handleCallback(this.callbacks.success,a),this.requestFinished(a.id)},_handleError:function(a){this.handleCallback(this.callbacks.error,a),this.requestFinished(a.id)},requestFinished:function(a){this._requests&&this._requests[a]&&(this._requests[a]=null,delete this._requests[a])},cancelRequest:function(a){this._requests&&this._requests[a]&&(this._requests[a].cancel(),this.requestFinished(a))},cancelAllRequest:function(){c.each(this._requests,function(a,b){this.cancelRequest(b)},this)}}),d.SocketIO=d.Object.extend({_type:"M.SocketIO",host:"",path:"",resource:"",script:"libs/socket.io.js",events:null,_socket:null,_events:null,create:function(a){return this.extend(a)},emit:function(a,b,c){this._socket.emit(a,b,c)},on:function(a,b){var c=this;this._socket.on(a,function(a){c.handleCallback(b,a)})},disconnect:function(){var a=this;this._socket&&(this._socket.removeAllListeners(),this._socket.on("connect",function(b){a.connected(b)}),this._socket.on("disconnect",function(b){a.disconnected(b)})),this._socket.disconnect()},connect:function(a){var b=this,d=this.host;a&&(d+="?"+(c.isString(a)?a:$.param(a)));var e=this.resource?{resource:this.resource}:{};this._socket=io.connect(d,e),this._socket.on("connect",function(a){b.connected(a)}),b._registerEvents()},ready:function(){this.connect()},error:function(a){console.log(a)},getEventHandler:function(a){return this._events[a]},_init:function(){if(Object.getPrototypeOf(this)===d.SocketIO){this._initEvents();var a=this;require([this.script],function(){a.ready()})}},_initEvents:function(){this.events=this.events||{},this._events={},c.each(this.events,function(a){this._addEvent(name,a)},this)},_addEvent:function(a,b){c.isFunction(b)&&(b={action:b}),b.target||(b.target=this),this._events[a]=b},_registerEvents:function(){var a=this;this._socket.on("disconnect",function(b){a.disconnect(b)}),c.each(this._events,function(b,c){this._socket.on(c,function(c){a.handleCallback(b,c)})},this)},connected:function(){},disconnected:function(){}}),d.Field=function(a){this.merge(a),this.initialize.apply(this,arguments)},d.Field.extend=b.Model.extend,d.Field.create=d.create,c.extend(d.Field.prototype,d.Object,{_type:"M.Field",name:null,type:null,defaultValue:void 0,length:null,required:NO,persistent:YES,initialize:function(){},create:function(a){var b=this.extend({name:a.name,type:a.type,defaultValue:a.defaultValue,length:a.length,required:a.required,persistent:a.persistent});return b},merge:function(a){this.name=c.isUndefined(a.name)?this.name:a.name,this.type=c.isUndefined(a.type)?this.type:a.type,this.defaultValue=c.isUndefined(a.defaultValue)?this.defaultValue:a.defaultValue,this.length=c.isUndefined(a.length)?this.length:a.length,this.required=c.isUndefined(a.required)?this.required:a.required,this.persistent=c.isUndefined(a.persistent)?this.persistent:a.persistent},transform:function(a,b){b=b||this.type;try{if(c.isUndefined(a))return this.defaultValue;if(b===d.CONST.TYPE.STRING||b===d.CONST.TYPE.TEXT)return c.isObject(a)?JSON.stringify(a):c.isNull(a)?"null":a.toString();if(b===d.CONST.TYPE.INTEGER)return parseInt(a);if(b===d.CONST.TYPE.BOOLEAN)return 1==a||"true"===a;if(b===d.CONST.TYPE.FLOAT)return parseFloat(a);if(b===d.CONST.TYPE.OBJECT||b===d.CONST.TYPE.ARRAY){if(!c.isObject(a))return c.isString(a)?JSON.parse(a):null}else if(b===d.CONST.TYPE.DATE){if(!d.Date.isPrototypeOf(a)){var e=a?d.Date.create(a):null;return e&&e.isValid()?e:null}}else if(b===d.CONST.TYPE.OBJECTID&&!d.ObjectID.prototype.isPrototypeOf(a))return c.isString(a)?new d.ObjectID(a):null;return a}catch(f){d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"Failed converting value! "+f.message)}},equals:function(a,b){var d=this.transform(a),e=this.transform(b);return this._equals(d,e,c.isArray(d))},isBinary:function(a){return"undefined"!=typeof Uint8Array&&a instanceof Uint8Array||a&&a.$Uint8ArrayPolyfill},detectType:function(a){return c.isNumber(a)?d.CONST.TYPE.FLOAT:c.isString(a)?d.CONST.TYPE.STRING:c.isBoolean(a)?d.CONST.TYPE.BOOLEAN:c.isArray(a)?d.CONST.TYPE.ARRAY:c.isNull(a)?d.CONST.TYPE.NULL:c.isDate(a)||d.Date.isPrototypeOf(a)?d.CONST.TYPE.DATE:d.ObjectID.prototype.isPrototypeOf(a)?d.CONST.TYPE.OBJECTID:this.isBinary(a)?d.CONST.TYPE.BINARY:d.CONST.TYPE.OBJECT},typeOrder:function(a){switch(a){case d.CONST.TYPE.NULL:return 0;case d.CONST.TYPE.FLOAT:return 1;case d.CONST.TYPE.STRING:return 2;case d.CONST.TYPE.OBJECT:return 3;case d.CONST.TYPE.ARRAY:return 4;case d.CONST.TYPE.BINARY:return 5;case d.CONST.TYPE.DATE:return 6}return-1},_equals:function(a,b,d){var e,f=this;if(a===b)return!0;if(!a||!b)return!1;if(!c.isObject(a)||!c.isObject(b))return!1;if(a instanceof Date&&b instanceof Date)return a.valueOf()===b.valueOf();if(this.isBinary(a)&&this.isBinary(b)){if(a.length!==b.length)return!1;for(e=0;e<a.length;e++)if(a[e]!==b[e])return!1;return!0}if(c.isFunction(a.equals))return a.equals(b,options);if(c.isArray(a)){if(!c.isArray(b))return!1;if(a.length!==b.length)return!1;for(e=0;e<a.length;e++)if(!f.equals(a[e],b[e],d))return!1;return!0}var g;if(d){var h=[];return c.each(b,function(a,b){h.push(b)}),e=0,g=c.all(a,function(a,c){return e>=h.length?!1:c!==h[e]?!1:f.equals(a,b[h[e]],d)?(e++,!0):!1}),g&&e===h.length}return e=0,g=c.all(a,function(a,g){return c.has(b,g)?f.equals(a,b[g],d)?(e++,!0):!1:!1}),g&&c.size(b)===e},_cmp:function(a,b){if(void 0===a)return void 0===b?0:-1;if(void 0===b)return 1;var c=this.detectType(a),e=this.detectType(b),f=this.typeOrder(c),g=this.typeOrder(e);if(f!==g)return g>f?-1:1;if(c!==e)throw Error("Missing type coercion logic in _cmp");if(7===c&&(c=e=2,a=a.toHexString(),b=b.toHexString()),c===d.CONST.TYPE.DATE&&(c=e=1,a=a.getTime(),b=b.getTime()),c===d.CONST.TYPE.FLOAT)return a-b;if(e===d.CONST.TYPE.STRING)return b>a?-1:a===b?0:1;if(c===d.CONST.TYPE.OBJECT){var h=function(a){var b=[];for(var c in a)b.push(c),b.push(a[c]);return b};return this._cmp(h(a),h(b))}if(c===d.CONST.TYPE.ARRAY)for(var i=0;;i++){if(i===a.length)return i===b.length?0:-1;if(i===b.length)return 1;var j=this._cmp(a[i],b[i]);if(0!==j)return j}if(c===d.CONST.TYPE.BINARY){if(a.length!==b.length)return a.length-b.length;for(i=0;i<a.length;i++){if(a[i]<b[i])return-1;if(a[i]>b[i])return 1}return 0}if(c===d.CONST.TYPE.BOOLEAN)return a?b?0:1:b?-1:0;if(c===d.CONST.TYPE.NULL)return 0;throw Error("Unknown type to sort")}}),d.Entity=function(a){var b=this.fields;this.fields={},this._mergeFields(b),a=a||{},a.fields&&this._mergeFields(a.fields),this.typeMapping=a.typeMapping||this.typeMapping,this.collection=a.collection||this.collection,this.idAttribute=a.idAttribute||this.idAttribute||(this.collection&&this.collection.prototype.model?this.collection.prototype.model.idAttribute:""),this._updateFields(this.typeMapping),this.initialize.apply(this,arguments)},d.Entity.from=function(a,b){if(d.Entity.prototype.isPrototypeOf(a))b&&b.typeMapping&&a._updateFields(b.typeMapping);else if(c.isFunction(a)&&d.Entity.prototype.isPrototypeOf(a.prototype))a=new a(b);else{"string"==typeof a&&(a={name:a});var e=d.Entity.extend(a);a=new e(b)}return a},d.Entity.extend=b.Model.extend,d.Entity.create=d.create,c.extend(d.Entity.prototype,d.Object,{_type:"M.Entity",name:"",idAttribute:"",collection:null,model:null,fields:{},initialize:function(){},getFields:function(){return this.fields},getField:function(a){return this.fields[a]},getFieldName:function(a){var b=this.getField(a);return b&&b.name?b.name:a},getKey:function(){return this.idAttribute||d.Model.idAttribute},getKeys:function(){return this.splitKey(this.getKey())},splitKey:function(a){var b=[];return c.isString(a)&&c.each(a.split(","),function(a){var c=a.trim();c&&b.push(c)}),b},_mergeFields:function(a){c.isObject(this.fields)||(this.fields={});var b=this;c.isObject(a)&&c.each(a,function(a,c){b.fields[c]?b.fields[c].merge(a):b.fields[c]=new d.Field(a)})},_updateFields:function(a){var b=this;c.each(this.fields,function(c,d){c.persistent===NO?delete b.fields[d]:(c.name||(c.name=d),a&&a[c.type]&&(c.type=a[c.type]))})},toAttributes:function(a){if(a&&!c.isEmpty(this.fields)){var b,d={};return c.each(this.fields,function(e,f){b=c.isFunction(a.get)?a.get(e.name):a[e.name],d[f]=b}),d}return a},fromAttributes:function(a){if(a&&!c.isEmpty(this.fields)){var b={};return c.each(this.fields,function(d,e){var f=c.isFunction(a.get)?a.get(e):a[e];f=d.transform(f),c.isUndefined(f)||(b[d.name]=f)}),b}return a},setId:function(a,b){return a&&b&&this.idAttribute&&(a[this.idAttribute]=b),a},getId:function(a){return a&&this.idAttribute?a[this.idAttribute]:void 0}}),d.Model=b.Model.extend(d.Object),d.Model.create=d.create,c.extend(d.Model.prototype,{_type:"M.Model",isModel:YES,entity:null,changedSinceSync:{},initialize:function(a,b){b=b||{},this.idAttribute=b.idAttribute||this.idAttribute,this.store=this.store||(this.collection?this.collection.store:null)||b.store,this.store&&c.isFunction(this.store.initModel)&&this.store.initModel(this,b),this.entity=this.entity||(this.collection?this.collection.entity:null)||b.entity,this.entity&&(this.entity=d.Entity.from(this.entity,{typeMapping:b.typeMapping}),this.idAttribute=this.entity.idAttribute||this.idAttribute),this.credentials=this.credentials||(this.collection?this.collection.credentials:null)||b.credentials,this.on("change",this.onChange,this),this.on("sync",this.onSync,this)},sync:function(a,e,f){var g=(f?f.store:null)||this.store;if(g&&c.isFunction(g.sync))return g.sync.apply(this,arguments);if(f&&this.credentials){var h=this.credentials;f.beforeSend=function(a){d.Request.setAuthentication(a,h)}}return b.sync.apply(this,arguments)},onChange:function(a){var b=a.changedAttributes();if(c.isObject(b))for(attr in b)val=b[attr],this.changedSinceSync[attr]=val},onSync:function(){this.changedSinceSync={}},getUrlRoot:function(){if(this.urlRoot)return c.isFunction(this.urlRoot)?this.urlRoot():this.urlRoot;if(this.collection)return this.collection.getUrlRoot();if(this.url){var a=c.isFunction(this.url)?this.url():this.url;return a&&this.id&&a.indexOf(this.id)>0?a.substr(0,a.indexOf(this.id)):a}}}),d.Collection=b.Collection.extend(d.Object),d.Collection.create=d.create,c.extend(d.Collection.prototype,{_type:"M.Collection",isCollection:YES,model:d.Model,entity:null,initialize:function(a){if(a=a||{},this.store=a.store||this.store||(this.model?this.model.prototype.store:null),this.entity=a.entity||this.entity||(this.model?this.model.prototype.entity:null),this.store&&c.isFunction(this.store.initCollection)&&this.store.initCollection(this,a),this.entity)this.entity=d.Entity.from(this.entity,{model:this.model,typeMapping:a.typeMapping});else if(this.url){var b=d.Request.getLocation(this.url).pathname.match(/([^\/]+)\/?$/);b&&b.length>1&&(this.entity=d.Entity.from(b[1]))}},select:function(a){var b=a.where?d.DataSelector.create(a.where):null,e=d.Collection.create(null,{model:this.model});return c.each(this,function(a){(!b||b.matches(a.attributes))&&e.add(a)}),a.sort&&e.sortBy(d.DataSelector.compileSort(a.sort)),e},sync:function(a,e,f){var g=(f?f.store:null)||this.store;if(g&&c.isFunction(g.sync))return g.sync.apply(this,arguments);if(f&&this.credentials){var h=this.credentials;f.beforeSend=function(a){d.Request.setAuthentication(a,h)}}return b.sync.apply(this,arguments)},getUrlRoot:function(){return c.isFunction(this.url)?this.url():this.url}}),d.DataSelector=d.Object.extend({_type:"M.DataSelector",_selector:null,create:function(a){var b=this.extend({_selector:null});return b.init(a),b},init:function(a){this._selector=this.compileSelector(a)},matches:function(a){return c.isFunction(this._selector)?this._selector(a):!1},hasOperators:function(a){var b=void 0;for(var c in a){var d="$"===c.substr(0,1);if(void 0===b)b=d;else if(b!==d)throw new Error("Inconsistent selector: "+a)}return!!b},compileSelector:function(a){if(a instanceof Function)return function(b){return a.call(b)};if(this._selectorIsId(a))return function(b){var e=c.isFunction(b.getId)?b.getId():b._id||b.id;return d.DataField.equals(e,a)};if(!a||"_id"in a&&!a._id)return function(){return!1};if(c.isBoolean(a)||c.isArray(a)||d.DataField.isBinary(a))throw new Error("Invalid selector: "+a);return this.compileDocSelector(a)},compileDocSelector:function(a){var b=d.DataSelector,e=[];return c.each(a,function(a,d){if("$"===d.substr(0,1)){if(!c.has(b.LOGICAL_OPERATORS,d))throw new Error("Unrecognized logical operator: "+d);e.push(b.LOGICAL_OPERATORS[d](a))}else{var f=b._makeLookupFunction(d),g=b.compileValueSelector(a);e.push(function(a){var b=f(a);return c.any(b,g)})}}),function(a){var b=c.isFunction(a.getData)?a.getData():a;return c.all(e,function(a){return a(b)})}},compileValueSelector:function(a){var b=d.DataSelector;if(null==a)return function(a){return b._anyIfArray(a,function(a){return null==a})};if(!c.isObject(a))return function(c){return b._anyIfArray(c,function(b){return b===a})};if(c.isRegExp(a))return function(d){return c.isUndefined(d)?!1:b._anyIfArray(d,function(b){return a.test(b)})};if(c.isArray(a))return function(d){return c.isArray(d)?b._anyIfArrayPlus(d,function(c){return b._equal(a,c)}):!1};if(this.hasOperators(a)){var e=[];return c.each(a,function(d,f){if(!c.has(b.VALUE_OPERATORS,f))throw new Error("Unrecognized operator: "+f);e.push(b.VALUE_OPERATORS[f](d,a.$options))}),function(a){return c.all(e,function(b){return b(a)})}}return function(c){return b._anyIfArray(c,function(c){return b._equal(a,c)})}},_makeLookupFunction:function(a){var b,d,e,f=a.indexOf(".");if(-1===f)b=a;else{b=a.substr(0,f);var g=a.substr(f+1);d=this._makeLookupFunction(g),e=/^\d+(\.|$)/.test(g)}return function(a){if(null==a)return[void 0];var f=a[b];return d?c.isArray(f)&&0===f.length?[void 0]:((!c.isArray(f)||e)&&(f=[f]),Array.prototype.concat.apply([],c.map(f,d))):[f]}},_anyIfArray:function(a,b){return c.isArray(a)?c.any(a,b):b(a)},_anyIfArrayPlus:function(a,b){return b(a)?!0:c.isArray(a)&&c.any(a,b)},_selectorIsId:function(a){return c.isString(a)||c.isNumber(a)},_equal:function(a,b){return d.DataField._equals(a,b,!0)},_cmp:function(a,b){return d.DataField._cmp(a,b)},LOGICAL_OPERATORS:{$and:function(a){if(!c.isArray(a)||c.isEmpty(a))throw Error("$and/$or/$nor must be nonempty array");var b=c.map(a,d.DataSelector.compileDocSelector);return function(a){return c.all(b,function(b){return b(a)})}},$or:function(a){if(!c.isArray(a)||c.isEmpty(a))throw Error("$and/$or/$nor must be nonempty array");var b=c.map(a,d.DataSelector.compileDocSelector);return function(a){return c.any(b,function(b){return b(a)})}},$nor:function(a){if(!c.isArray(a)||c.isEmpty(a))throw Error("$and/$or/$nor must be nonempty array");var b=c.map(a,d.DataSelector.compileDocSelector);return function(a){return c.all(b,function(b){return!b(a)})}},$where:function(a){return a instanceof Function||(a=new Function("return "+a)),function(b){return a.call(b)}}},VALUE_OPERATORS:{$in:function(a){if(!c.isArray(a))throw new Error("Argument to $in must be array");return function(b){return d.DataSelector._anyIfArrayPlus(b,function(b){return c.any(a,function(a){return d.DataSelector._equal(a,b)})})}},$all:function(a){if(!c.isArray(a))throw new Error("Argument to $all must be array");return function(b){return c.isArray(b)?c.all(a,function(a){return c.any(b,function(b){return d.DataSelector._equal(a,b)})}):!1}},$lt:function(a){return function(b){return d.DataSelector._anyIfArray(b,function(b){return d.DataSelector._cmp(b,a)<0})}},$lte:function(a){return function(b){return d.DataSelector._anyIfArray(b,function(b){return d.DataSelector._cmp(b,a)<=0})}},$gt:function(a){return function(b){return d.DataSelector._anyIfArray(b,function(b){return d.DataSelector._cmp(b,a)>0})}},$gte:function(a){return function(b){return d.DataSelector._anyIfArray(b,function(b){return d.DataSelector._cmp(b,a)>=0})}},$ne:function(a){return function(b){return!d.DataSelector._anyIfArrayPlus(b,function(b){return d.DataSelector._equal(b,a)})}},$nin:function(a){if(!c.isArray(a))throw new Error("Argument to $nin must be array");var b=this.VALUE_OPERATORS.$in(a);return function(a){return void 0===a?!0:!b(a)}},$exists:function(a){return function(b){return a===(void 0!==b)}},$mod:function(a){var b=a[0],c=a[1];return function(a){return _anyIfArray(a,function(a){return a%b===c})}},$size:function(a){return function(b){return c.isArray(b)&&a===b.length}},$type:function(a){return function(b){return c.isUndefined(b)?!1:d.DataSelector._anyIfArray(b,function(b){return d.DataField.detectType(b)===a})}},$regex:function(a,b){if(c.isUndefined(b)){if(/[^gim]/.test(b))throw new Error("Only the i, m, and g regexp options are supported");var e=a instanceof RegExp?a.source:a;a=new RegExp(e,b)}else a instanceof RegExp||(a=new RegExp(a));
return function(b){return c.isUndefined(b)?!1:d.DataSelector._anyIfArray(b,function(b){return a.test(b)})}},$options:function(){return function(){return!0}},$elemMatch:function(a){var b=d.DataSelector.compileDocSelector(a);return function(a){return c.isArray(a)?c.any(a,function(a){return b(a)}):!1}},$not:function(a){var b=d.DataSelector.compileDocSelector(a);return function(a){return!b(a)}}},compileSort:function(a){var b=[];if(c.isArray(a))for(var e=0;e<a.length;e++)"string"==typeof a[e]?b.push({lookup:this._makeLookupFunction(a[e]),ascending:!0}):b.push({lookup:this._makeLookupFunction(a[e][0]),ascending:"desc"!==a[e][1]});else{if("object"!=typeof a)throw Error("Bad sort specification: ",JSON.stringify(a));for(var f in a)b.push({lookup:this._makeLookupFunction(f),ascending:a[f]>=0})}if(0===b.length)return function(){return 0};var g=function(a,b){var e,f=!0;return c.each(a,function(a){c.isArray(a)||(a=[a]),c.isArray(a)&&0===a.length&&(a=[void 0]),c.each(a,function(a){if(f)e=a,f=!1;else{var c=d.DataSelector._cmp(e,a);(b&&c>0||!b&&0>c)&&(e=a)}})}),e};return function(a,e){a=c.isFunction(a.getData)?a.getData():a,e=c.isFunction(e.getData)?e.getData():e;for(var f=0;f<b.length;++f){var h=b[f],i=g(h.lookup(a),h.ascending),j=g(h.lookup(e),h.ascending),k=d.DataSelector._cmp(i,j);if(0!==k)return h.ascending?k:-k}return 0}}}),d.SqlSelector=d.DataSelector.extend({_type:"M.SqlSelector",_selector:null,_query:null,_entity:null,create:function(a,b){var c=this.extend({_entity:b,_selector:null,_query:null});return c.init(a),c},init:function(a){this._selector=this.compileSelector(a),this._query=this.buildSqlQuery(a)},buildStatement:function(){return this._query},buildSqlQuery:function(a){if(a instanceof Function)return"";if(c.isString(a))return a;if(!a||"_id"in a&&!a._id)return"1=2";if(c.isBoolean(a)||c.isArray(a)||d.DataField.isBinary(a))throw new Error("Invalid selector: "+a);return this.buildSqlWhere(a)()},buildSqlWhere:function(a){var b=this,d=[];return c.each(a,function(a,e){if("$"===e.substr(0,1))d.push(b.buildLogicalOperator(e,a));else{var f=b.buildLookup(e),g=b.buildValueSelector(a);c.isFunction(g)&&d.push(function(){return g(f)})}}),function(){var a="";return c.each(d,function(d){c.isFunction(d)&&(a+=d.call(b))}),a}},buildValueSelector:function(a){var b=this;if(null==a)return function(a){return a+" IS NULL"};if(!c.isObject(a))return function(c){return c+" = "+b.buildValue(a)};if(c.isRegExp(a)){var d=a.toString(),e=d.match(/\/[\^]?([^^.*$'+()]*)[\$]?\//);if(e&&e.length>1){var f=d.indexOf("/^")<0?"%":"",g=d.indexOf("$/")<0?"%":"";return function(a){return a+' LIKE "'+f+e[1]+g+'"'}}return null}if(c.isArray(a))return null;if(this.hasOperators(a)){var h=[];return c.each(a,function(a,d){if(!c.has(b.VALUE_OPERATORS,d))throw new Error("Unrecognized operator: "+d);h.push(b.VALUE_OPERATORS[d](a,b))}),function(a){return b.LOGICAL_OPERATORS.$and(h,a)}}return function(c){return c+" = "+b.buildValue(a)}},buildLookup:function(a){var b=this._entity?this._entity.getField(a):null;return a=b&&b.name?b.name:a,'"'+a+'"'},buildValue:function(a){return c.isString(a)?'"'+a.replace(/"/g,'""')+'"':a},buildLogicalOperator:function(a,b){if(c.has(this.LOGICAL_OPERATORS,a)){if(!c.isArray(b)||c.isEmpty(b))throw Error("$and/$or/$nor must be nonempty array");var d=c.map(b,this.buildSqlWhere,this),e=this;return function(b){return e.LOGICAL_OPERATORS[a](d,b)}}throw new Error("Unrecognized logical operator: "+a)},LOGICAL_OPERATORS:{$and:function(a,b){var d="",e=0;return c.each(a,function(a){var c=null!=a?a(b):"";c&&(e++,d+=d?" AND "+c:c)}),e>1?"( "+d+" )":d},$or:function(a,b){var d="",e=!1;return c.each(a,function(a){var c=null!=a?a(b):"";e|=!c,d+=d&&c?" OR "+c:c}),e?"":"( "+d+" )"},$nor:function(a,b){var d="",e=!1;return c.each(a,function(a){var c=null!=a?a(b):"";e|=!c,d+=d&&c?" OR "+c:c}),e?"":"NOT ( "+d+" )"}},VALUE_OPERATORS:{$in:function(){return null},$all:function(){return null},$lt:function(a,b){return function(c){return c+" < "+b.buildValue(a)}},$lte:function(a,b){return function(c){return c+" <= "+b.buildValue(a)}},$gt:function(a,b){return function(c){return c+" > "+b.buildValue(a)}},$gte:function(a,b){return function(c){return c+" > "+b.buildValue(a)}},$ne:function(a,b){return function(c){return c+" <> "+b.buildValue(a)}},$nin:function(){return null},$exists:function(){return function(a){return a+" IS NOT NULL"}},$mod:function(){return null},$size:function(){return null},$type:function(){return null},$regex:function(){return null},$options:function(){return null},$elemMatch:function(){return null},$not:function(a,b){var c=b.buildSqlWhere(a);return function(a){return"NOT ("+c(a)+")"}}}}),d.Store=function(){this.initialize.apply(this,arguments)},d.Store.extend=b.Model.extend,d.Store.create=d.create,c.extend(d.Store.prototype,b.Events,d.Object,{_type:"M.Store",name:"",url:"",entities:null,typeMapping:function(){var a={};return a[d.CONST.TYPE.OBJECTID]=d.CONST.TYPE.STRING,a[d.CONST.TYPE.DATE]=d.CONST.TYPE.STRING,a[d.CONST.TYPE.BINARY]=d.CONST.TYPE.TEXT,a}(),initialize:function(a){a=a||{},this.name=a.name||this.name,this.url=a.url||this.url,this.typeMapping=a.typeMapping||this.typeMapping;var b=a.entities||this.entities||{};this.entities={};for(var c in b){var e=d.Entity.from(b[c],{store:this,typeMapping:this.typeMapping});e.name=e.name||c;var f=e.collection||d.Collection.extend({model:d.Model.extend({})}),g=f.prototype.model;f.prototype.lastEntity=g.prototype.lastEntity=f.prototype.entity,f.prototype.lastStore=g.prototype.lastStore=f.prototype.store,f.prototype.entity=g.prototype.entity=c,f.prototype.store=g.prototype.store=this,e.idAttribute=e.idAttribute||g.prototype.idAttribute,this.entities[c]=e}},getEntity:function(a){if(a){var b=a.entity||a,d=c.isString(b)?b:b.name;if(d)return this.entities[d]||(b&&b.name?b:{name:d})}},getCollection:function(a){return c.isString(a)&&(a=this.entities[a]),a&&a.collection?d.Collection.prototype.isPrototypeOf(a.collection)?a.collection:new a.collection:void 0},createModel:function(a,b){if(c.isString(a)&&(a=this.entities[a]),a&&a.collection){var d=a.collection.model||a.collection.prototype.model;if(d)return new d(b)}},getArray:function(a){return c.isArray(a)?a:d.isCollection(a)?a.models:c.isObject(a)?[a]:[]},getDataArray:function(a){var d=[];if(c.isArray(a)||b.Collection.prototype.isPrototypeOf(a))c.each(a,function(a){var b=this.getAttributes(a);b&&d.push(b)});else{var e=this.getAttributes(a);e&&d.push(this.getAttributes(e))}return d},getAttributes:function(a){return b.Model.prototype.isPrototypeOf(a)?a.attributes:c.isObject(a)?a:null},initModel:function(){},initCollection:function(){},initEntity:function(){},sync:function(){},fetch:function(a,b){if(!a||a.models||a.attributes||b||(b=a),a&&(a.models||a.attributes)||!b||!b.entity||(a=this.getCollection(b.entity)),a&&a.fetch){var d=c.extend({},b||{},{store:this});a.fetch(d)}},create:function(a,b,d){if(!a||a.models||d||(b=a,d=b),a&&a.models||!d||!d.entity||(a=this.getCollection(d.entity)),a&&a.create){var e=c.extend({},d||{},{store:this});a.create(b,e)}},save:function(a,b,d){if(!a||a.attributes||d||(b=a,d=b),a&&a.attributes||!d||!d.entity||(a=this.createModel(d.entity)),a&&a.save){var e=c.extend({},d||{},{store:this});a.save(b,e)}},destroy:function(a,b){if(a&&a.destroy){var d=c.extend({},b||{},{store:this});a.destroy(d)}},_checkEntity:function(a,b){if(!b){var c=d.Error.create(d.CONST.ERROR.VALIDATION_PRESENCE,"No valid entity passed.");return this.handleCallback(a.error,c),this.handleCallback(a.finish,c),!1}return!0},_checkData:function(a,b){if(!(c.isArray(b)&&0!=b.length||c.isObject(b))){var e=d.Error.create(d.CONST.ERROR.VALIDATION_PRESENCE,"No data passed.");return this.handleCallback(a.error,e),this.handleCallback(a.finish,e),!1}return!0},handleSuccess:function(a){var b=Array.prototype.slice.call(arguments,1);a.success&&this.handleCallback.apply(this,[a.success].concat(b)),a.finish&&this.handleCallback.apply(this,[a.finish].concat(b))},handleError:function(a){var b=Array.prototype.slice.call(arguments,1);a.error&&this.handleCallback.apply(this,[a.error].concat(b)),a.finish&&this.handleCallback.apply(this,[a.finish].concat(b))}}),d.SocketStore=d.Store.extend({_type:"M.SocketStore",_transactionFailed:!1,_selector:null,name:"bikini",size:5242880,version:"1.2",host:"",path:"",msgStore:null,messages:null,typeMapping:{binary:"text",date:"string"},initialize:function(a){d.Store.prototype.initialize.apply(this,arguments);var b=this;a=a||{},this.host=a.host||this.host,this.path=a.path||this.path,this.resource=a.resource||this.resource,this._initStores(),this._socket=d.SocketIO.create({host:this.host,path:this.path,resource:this.resource,connected:function(){if(b._initialized=!0,b.entities)for(var a in b.entities){var c=b.entities[a];b._bindEntity(c)}b.sendMessages()}})},_initStores:function(){var a=d.Collection.extend({model:d.Model.extend({idAttribute:"_id"})});this.msgStore=new d.LocalStorageStore({entities:{messages:{collection:a}}}),this.messages=new a,this.messages.fetch()},_bindEntity:function(a){var b=this;a.channel=a.channel||"entity_"+a.name;var c=this.getLastMessageTime(a.channel);this._socket.on(a.channel,function(c){c&&(b.setLastMessageTime(a.channel,c.time),b.trigger(a.channel,c))}),this._socket.emit("bind",{entity:a.name,time:c}),this.sync("read",{},{entity:a.name,store:this})},_isValidChannel:function(a){return a&&0===a.indexOf("entity_")&&this.getEntity(a.substr(7))},getLastMessageTime:function(a){return localStorage.getItem("__"+a+"last_msg_time")||0},setLastMessageTime:function(a,b){b&&localStorage.setItem("__"+a+"last_msg_time",b)},onMessage:function(a){if(a&&a.method){var b={store:this.lastStore,merge:!0,fromMessage:!0},c=a.data;switch(a.method){case"patch":b.patch=!0;case"update":var d=this.get(a.id);case"create":d?d.save(c,b):this.create(c,b);break;case"delete":if(a.id){var d=this.get(a.id);d&&d.destroy(b)}}}},sync:function(a,b,c){var e=c.store||this.store;if(c.fromMessage)return e.handleCallback(c.success);var f=e.getEntity(b.entity||c.entity||this.entity);if(e&&f){var g=f.channel;d.isModel(b)&&!b.id&&b.set(b.idAttribute,(new d.ObjectID).toHexString()),d.isCollection(this)&&g&&!this.channel&&(this.channel=g,this.listenTo(e,g,e.onMessage,this));var h=e.getLastMessageTime(f.channel);"read"===a&&this.lastStore&&h||e.addMessage(a,b,this.lastStore?{}:c,f),this.lastStore&&(c.store=this.lastStore,this.lastStore.sync.apply(this,arguments))}},addMessage:function(a,b,d,e){var f=this;if(a&&b){var g=b.changedSinceSync,h=null,i=!1;switch(a){case"update":case"create":h=b.attributes,i=!0;break;case"patch":if(c.isEmpty(g))return;h=g,i=!0;break;case"delete":i=!0}var j={_id:b.id,id:b.id,method:a,data:h},k=function(a,b){f._initialized?f.emitMessage(a,b,d):f.handleCallback(d.success,b.data)};i?this.storeMessage(e.channel,j,k):k(e.channel,j)}},emitMessage:function(a,b,d){var e=this;console.log("emitMessage:"+b.id),this._socket.emit(a,b,function(b,f){e.removeMessage(a,b,function(a,b){if(f)e.handleCallback(d.error,f);else if(d.success){var g=b?b.data:null;e.handleCallback(d.success,g)}else if(e.setLastMessageTime(a,b.time),"read"===b.method)for(var h=c.isArray(b.data)?b.data:[b.data],i=0;i<h.length;i++){var j=h[i];j&&(e.trigger(a,{id:j._id,method:"update",data:j}),e.setLastMessageTime(a,b.time))}else e.trigger(a,b)})})},sendMessages:function(){var a=this;this.messages.each(function(b){var c=b.get("msg"),d=b.get("channel"),e=b.get("callback");a._isValidChannel(d)?e?e(d,c):a._initialized&&a.emitMessage(d,c,{}):a.removeMessage(d,c)})},mergeMessages:function(a){return a},storeMessage:function(a,b,d){var e=this.messages.get(b._id);e?e.save({msg:c.extend(e.get("msg"),b)}):this.messages.create({_id:b._id,id:b.id,msg:b,channel:a,callback:d}),d(a,b)},removeMessage:function(a,b,c){var d=this.messages.get(b._id);d&&d.destroy(),c(a,b)}}),d.LocalStorageStore=d.Store.extend({_type:"M.LocalStorageStore",name:"",ids:{},sync:function(a,b,e){var e=e||{},f=e.store||this.store,g=f.getEntity(b.entity||e.entity||this.entity);if(f&&g&&b){var h=b.id||("create"===a?(new d.ObjectID).toHexString():null),i=e.attrs||b.attributes;switch(a){case"patch":case"update":var j=f._getItem(g,h)||{};i=c.extend(j,i);case"create":f._setItem(g,h,i);break;case"delete":f._removeItem(g,h);break;case"read":if(h)i=f._getItem(g,h);else{i=[];var k=f._getItemIds(g);for(h in k){var j=f._getItem(g,h);j&&i.push(j)}}break;default:return}}i?f.handleSuccess(e,i):f.handleError(e)},_getKey:function(a,b){return"_"+a.name+"_"+b},_getItem:function(a,b){var c;if(a&&b)try{var e=JSON.parse(localStorage.getItem(this._getKey(a,b)));e?(c=a.toAttributes(e),a.setId(c,b)):this._delItemId(b)}catch(f){d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"Error while loading data from local storage: ",f)}return c},_setItem:function(a,b,c){if(a&&b&&c)try{var e=a.fromAttributes(c);localStorage.setItem(this._getKey(a,b),JSON.stringify(e)),this._addItemId(a,b)}catch(f){d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"Error while saving data to local storage: ",f)}},_removeItem:function(a,b){a&&b&&(localStorage.removeItem(this._getKey(a,b)),this._delItemId(a,b))},_addItemId:function(a,b){var c=this._getItemIds(a);b in c||(c[b]="",this._saveItemIds(a,c))},_delItemId:function(a,b){var c=this._getItemIds(a);b in c&&(delete c[b],this._saveItemIds(a,c))},_getItemIds:function(a){try{var b="__ids__"+a.name;return this.ids[a.name]||(this.ids[a.name]=JSON.parse(localStorage.getItem(b))||{}),this.ids[a.name]}catch(c){d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"Error while loading ids from local storage: ",c)}},_saveItemIds:function(a,b){try{var c="__ids__"+a.name;localStorage.setItem(c,JSON.stringify(b))}catch(e){d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"Error while saving ids to local storage: ",e)}}}),d.WebSqlStore=d.Store.extend({_type:"M.WebSqlStore",_transactionFailed:!1,_selector:null,name:"bikini",size:5242880,version:"1.2",db:null,typeMapping:function(){var a={};return a[d.CONST.TYPE.OBJECTID]=d.CONST.TYPE.STRING,a[d.CONST.TYPE.DATE]=d.CONST.TYPE.STRING,a[d.CONST.TYPE.OBJECT]=d.CONST.TYPE.TEXT,a[d.CONST.TYPE.ARRAY]=d.CONST.TYPE.TEXT,a[d.CONST.TYPE.BINARY]=d.CONST.TYPE.TEXT,a}(),sqlTypeMapping:function(){var a={};return a[d.CONST.TYPE.STRING]="varchar(255)",a[d.CONST.TYPE.TEXT]="text",a[d.CONST.TYPE.OBJECT]="text",a[d.CONST.TYPE.ARRAY]="text",a[d.CONST.TYPE.FLOAT]="float",a[d.CONST.TYPE.INTEGER]="integer",a[d.CONST.TYPE.DATE]="varchar(255)",a[d.CONST.TYPE.BOOLEAN]="boolean",a}(),initialize:function(a){d.Store.prototype.initialize.apply(this,arguments),this.version=a.version||this.version,this._openDb({error:function(a){d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,a)}})},_options:function(a,b){var d=c.extend({},b);return d.entity=this.getEntity(a.entity||b.entity||this.entity),d.data=this.getArray(a),d},sync:function(a,b,c){var e=c.store||this.store,c=e._options(b,c,this.entity);switch(a){case"create":e._insertOrReplace(c);break;case"update":case"patch":e._insertOrReplace(c);break;case"delete":e._delete(c);break;case"read":d.isCollection(this)&&(c.data=null),e._select(b,c)}},select:function(a){this._select(a)},dropTable:function(a){this._dropTable(a)},createTable:function(a){this._createTable(a)},execute:function(a){this._executeSql(a)},_openDb:function(a){var b,c;if(!this.db)try{window.openDatabase?this.db=window.openDatabase(this.name,"","",this.size):b=d.Error.create(d.CONST.ERROR.WEBSQL_NOT_SUPPORTED,"Your browser does not support WebSQL databases.")}catch(e){c=e}this.db?this.version&&this.db.version!=this.version?this._updateDb(a):this.handleSuccess(a,this.db):2==c?this._updateDb(a):(!b&&c&&(b=d.Error.create(d.CONST.ERROR.WEBSQL_DATABASE,c.message,c)),this.handleSuccess(a,b))},_updateDb:function(a){var b,e,f=this;try{var g=window.openDatabase(this.name,"","",this.size);try{var h=this._sqlUpdateDatabase(g.version,this.version);g.changeVersion(g.version,this.version,function(a){c.each(h,function(b){d.Logger.log(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"SQL-Statement: "+b),e=b,a.executeSql(b)})},function(b){var c=d.Error.create(d.CONST.ERROR.WEBSQL_SYNTAX,b,h);f.handleError(a,c,e)},function(){f.handleSuccess(a)})}catch(i){b=d.Error.create(d.CONST.ERROR.WEBSQL_DATABASE,i.message,i),d.Logger.error(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"changeversion failed, DB-Version: "+g.version)}}catch(i){b=d.Error.create(d.CONST.ERROR.WEBSQL_DATABASE,i.message,i)}b&&this.handleError(a,b)},_sqlUpdateDatabase:function(){var a=[];if(this.entities)for(var b in this.entities){var c=this.entities[b];a.push(this._sqlDropTable(b)),a.push(this._sqlCreateTable(c))}return a},_sqlDropTable:function(a){var b="DROP TABLE IF EXISTS '"+a+"'";return b},_sqlPrimaryKey:function(a,b){if(b&&1==b.length){var c=a.getField(b[0]);return c&&c.type===d.CONST.TYPE.INTEGER?b[0]+" INTEGER PRIMARY KEY ASC AUTOINCREMENT UNIQUE":b[0]+" PRIMARY KEY ASC UNIQUE"}return""},_sqlConstraint:function(a,b){return b&&b.length>1?"PRIMARY KEY ("+b.join(",")+") ON CONFLICT REPLACE":""},_sqlCreateTable:function(a){var b=this,d=a.getKeys(),e=1===d.length?this._sqlPrimaryKey(a,d):"",f=d.length>1?this._sqlConstraint(a,d):a.constraint||"",g="",h=a.getFields();c.each(h,function(a){if(!e||a.name!==d[0]){var c=b._dbAttribute(a);c&&(g+=(g?", ":"")+c)}});var i="CREATE TABLE IF NOT EXISTS '"+a.name+"' (";return i+=e?e+", ":"",i+=g,i+=f?", "+f:"",i+=");"},_sqlDelete:function(a,b){var c="DELETE FROM '"+b.name+"'",d=this._sqlWhere(a,b)||this._sqlWhereFromData(a,b);return d&&(c+=" WHERE "+d),c+=a.and?" AND "+a.and:""},_sqlWhere:function(a){var b=a.entity;this._selector=null;var e="";return c.isString(a.where)?e=a.where:c.isObject(a.where)&&(this._selector=d.SqlSelector.create(a.where,b),e=this._selector.buildStatement()),e},_sqlWhereFromData:function(a){var b=this,d=a.data,e=a.entity,f=[];if(d&&e&&e.idAttribute){var g,h=e.idAttribute,i=e.getField(h);if(c.each(d,function(a){g=c.isFunction(a.get)?a.get(h):a[h],c.isUndefined(g)||f.push(b._sqlValue(g,i))}),f.length>0)return h+" IN ("+f.join(",")+")"}return""},_sqlSelect:function(a){var b=a.entity,c="SELECT ";a.fields?a.fields.length>1?c+=a.fields.join(", "):1==a.fields.length&&(c+=a.fields[0]):c+="*",c+=" FROM '"+b.name+"'",a.join&&(c+=" JOIN "+a.join),a.leftJoin&&(c+=" LEFT JOIN "+a.leftJoin);var d=this._sqlWhere(a)||this._sqlWhereFromData(a);return d&&(c+=" WHERE "+d),a.order&&(c+=" ORDER BY "+a.order),a.limit&&(c+=" LIMIT "+a.limit),a.offset&&(c+=" OFFSET "+a.offset),c},_sqlValue:function(a,b){var c=b&&b.type?b.type:d.DataField.detectType(a);return c===d.CONST.TYPE.INTEGER||c===d.CONST.TYPE.FLOAT?a:c===d.CONST.TYPE.BOOLEAN?a?"1":"0":c===d.CONST.TYPE.NULL?"NULL":(a=d.DataField.transform(a,d.CONST.TYPE.STRING),a=a.replace(/"/g,'""'),'"'+a+'"')},_dbAttribute:function(a){if(a&&a.name){var b=this.sqlTypeMapping[a.type],c=a.required?" NOT NULL":"";if(b)return a.name+" "+b.toUpperCase()+c}},_dropTable:function(a){var b=this.getEntity(a);if(this._checkDb(a)&&this._checkEntity(b,a)){var c=this._sqlDropTable(b.name);this._transactionFailed=NO,this._executeTransaction(a,[c])}},_createTable:function(a){var b=this.getEntity(a);if(this._checkDb(a)&&this._checkEntity(b,a)){var c=this._sqlCreateTable(b);this._transactionFailed=NO,this._executeTransaction(a,[c])}},_insertOrReplace:function(a){var b=a.entity,d=a.data;if(this._checkDb(a)&&this._checkEntity(a,b)&&this._checkData(a,d)){for(var e=[],f="INSERT OR REPLACE INTO '"+b.name+"' (",g=0;g<d.length;g++){var h="",i=b.fromAttributes(d[g]),j=c.values(i),k=c.keys(i);if(j.length>0){var l=new Array(j.length).join("?,")+"?",m="'"+k.join("','")+"'";h+=f+m+") VALUES ("+l+");",e.push({statement:h,arguments:j})}}this._transactionFailed=NO,this._executeTransaction(a,e)}},_updateOrReplace:function(a){var b=a.entity,d=a.data;if(this._checkDb(a)&&this._checkEntity(a,b)&&this._checkData(a,d)){d=c.isArray(d)?d:[d];for(var e=this._sqlWhere(a),f=[],g="UPDATE OR REPLACE '"+b.name+"' SET ",h=0;h<d.length;h++){var i="",j=b.fromAttributes(d[h]),k=c.values(j),l=c.keys(j);if(k.length>0){var m="'"+l.join("'=?,'")+"'=?";i+=g+m+e+";",f.push({statement:i,arguments:k})}}this._transactionFailed=NO,this._executeTransaction(a,f)}},_select:function(a,b){var c=b.entity;if(this._checkDb(b)&&this._checkEntity(b,c)){var e,f=this._sqlSelect(b),g=this,h=d.isCollection(a);h&&(a=[]),this.db.readTransaction(function(b){var i=f.statement||f,j=f.arguments;e=i,d.Logger.log(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"SQL-Statement: "+i),b.executeSql(i,j,function(b,d){for(var e=d.rows.length,f=0;e>f;f++){var i=d.rows.item(f),j=c.toAttributes(i);if(!g._selector||g._selector.matches(j)){if(!h){a.set(j);break}a.push(j)}}},function(){})},function(a){var c=d.Error.create(d.CONST.ERROR.WEBSQL_SYNTAX,a);g.handleError(b,c,e)},function(){g.handleSuccess(b,a)})}},_delete:function(a,b){var c=this.getEntity(b);if(this._checkDb(b)&&this._checkEntity(b,c)){var d=this._sqlDelete(a,b,c);this._transactionFailed=NO,this._executeTransaction(b,[d])}},_executeSql:function(a){a.sql&&this._executeTransaction(a,[a.sql])},_executeTransaction:function(a,b){var e,f;if(this._checkDb(a)){var g=this;try{this.db.transaction(function(a){c.each(b,function(b){var c=b.statement||b,e=b.arguments;f=c,d.Logger.log(d.CONST.LOGGER.TAG_FRAMEWORK_DATA,"SQL-Statement: "+c),a.executeSql(c,e)})},function(b){g._transactionFailed=YES;var c=d.Error.create(d.CONST.ERROR.WEBSQL_SYNTAX,b);g.handleError(a,c,f)},function(){g.handleSuccess(a)})}catch(h){e=d.Error.create(d.CONST.ERROR.WEBSQL_UNKNOWN,h.message,h)}}e&&this.handleCallback(a.error,e,lastSql)},_checkDb:function(a){if(!this.db){var b=d.Error.create(d.CONST.ERROR.WEBSQL_NO_DBHANDLER,"db handler not initialized.");return this.handleError(a,b),!1}return!0}}),d.BikiniStore=d.Store.extend({_type:"M.BikiniStore",_transactionFailed:!1,_selector:null,name:"bikini",size:5242880,version:"1.2",host:"",path:"",resource:"live",endpoints:{},useLocalStore:!0,useSocketNotify:!0,useOfflineChange:!0,msgStore:null,messages:null,typeMapping:{binary:"text",date:"string"},initialize:function(a){d.Store.prototype.initialize.apply(this,arguments),a=a||{},this.socketio_path=a.socketio_path||this.socketio_path},initModel:function(){},initCollection:function(a){var b=a.getUrlRoot(),c=this.getEntity(a.entity);if(b&&c){var d=c.name,e=this._hashCode(b),f=d+e;a.channel=f;var g=this.endpoints[e];g||(g={},g.url=b,g.entity=c,g.channel=f,g.credentials=c.credentials||a.credentials,g.localStore=this.useLocalStore?this.createLocalStore(g):null,g.messages=this.useOfflineChange?this.createMsgCollection(g):null,g.socket=this.useSocketNotify?this.createSocket(g,a):null,this.endpoints[e]=g),a.endpoint=g,a.localStore=g.localStore,a.messages=g.messages,a.listenTo(this,f,this.onMessage,a),g.messages&&!g.socket&&this.sendMessages(g,a)}},getEndpoint:function(a){if(a){var b=this._hashCode(a);return this.endpoints[b]}},createLocalStore:function(a){var b={};return b[a.entity.name]={name:a.channel},new d.LocalStorageStore({entities:b})},createMsgCollection:function(a){var b="msg-"+a.channel,c=d.Collection.extend({model:d.Model.extend({idAttribute:"_id"})}),e=new c({entity:b,store:new d.LocalStorageStore});return e.fetch(),e},createSocket:function(a,b){var c=d.Request.getLocation(a.url),e=c.protocol+"//"+c.host,f=c.pathname,f=this.socketio_path||f+("/"===f.charAt(f.length-1)?"":"/")+"live",g=f&&0==f.indexOf("/")?f.substr(1):f,h=this,i=d.SocketIO.create({host:e,resource:g,connected:function(){h._bindChannel(i,a),h.sendMessages(a,b)}});return i},_bindChannel:function(a,b){var c=this,d=b.channel,e=b.entity.name,f=this.getLastMessageTime(d);a.on(d,function(a){a&&(c.setLastMessageTime(d,a.time),c.trigger(d,a))}),a.emit("bind",{entity:e,channel:d,time:f})},getLastMessageTime:function(a){return localStorage.getItem("__"+a+"last_msg_time")||0},setLastMessageTime:function(a,b){b&&localStorage.setItem("__"+a+"last_msg_time",b)},_hashCode:function(a){var b,c,d=0;if(0==a.length)return d;for(b=0,l=a.length;l>b;b++)c=a.charCodeAt(b),d=(d<<5)-d+c,d|=0;return d},onMessage:function(a){if(a&&a.method){var b={store:this.localStore,merge:!0,fromMessage:!0,entity:this.entity.name},c=a.data;switch(a.method){case"patch":b.patch=!0;case"update":case"create":var d=a.id?this.get(a.id):null;d?d.save(c,b):this.create(c,b);break;case"delete":if(a.id)if("all"===a.id)this.reset();else{var d=this.get(a.id);d&&d.destroy(b)}}}},sync:function(a,b,c){var e=c.store||this.store;if(c.fromMessage)return e.handleCallback(c.success);var f=e.getEndpoint(this.getUrlRoot());if(e&&f){var g=this.channel;d.isModel(b)&&!b.id&&b.set(b.idAttribute,(new d.ObjectID).toHexString());var h=e.getLastMessageTime(g);"read"===a&&this.localStore&&h||e.addMessage(a,b,this.localStore?{}:c,f),f.localStore&&(c.store=f.localStore,f.localStore.sync.apply(this,arguments))}},addMessage:function(a,b,d,e){var f=this;if(a&&b){var g=b.changedSinceSync,h=null,i=!1;switch(a){case"update":case"create":h=b.attributes,i=!0;break;case"patch":if(c.isEmpty(g))return;h=g,i=!0;break;case"delete":i=!0}var j={_id:b.id,id:b.id,method:a,data:h},k=function(a,c){f.emitMessage(a,c,d,b)};i?this.storeMessage(e,j,k):k(e,j)}},emitMessage:function(a,e,f,g){var h=a.channel,i=this,j=a.url;e.id&&"create"!==e.method&&(j+="/"+e.id),b.sync(e.method,g,{url:j,error:function(b,c){!b.responseText&&i.useOfflineChange?i.handleCallback(f.success,e.data):i.removeMessage(a,e,function(){i.handleCallback(f.error,c)})},success:function(b){i.removeMessage(a,e,function(a,d){if(f.success){var e=b;i.handleCallback(f.success,e)}else if("read"===d.method)for(var g=c.isArray(b)?b:[b],j=0;j<g.length;j++)b=g[j],b&&i.trigger(h,{id:b._id,method:"update",data:b});else i.trigger(h,d)})},beforeSend:function(b){d.Request.setAuthentication(b,a.credentials)}})},sendMessages:function(a,b){if(a&&a.messages){var c=this;a.messages.each(function(d){var e;try{e=JSON.parse(d.get("msg"))}catch(f){}var g=d.get("channel");if(e&&g){var h=c.createModel({collection:b},e.data);c.emitMessage(a,e,{},h)}else d.destroy()})}},mergeMessages:function(a){return a},storeMessage:function(a,b,d){if(a&&a.messages&&b){var e=a.channel,f=a.messages.get(b._id);if(f){var g=JSON.parse(f.get("msg"));f.save({msg:JSON.stringify(c.extend(g,b))})}else a.messages.create({_id:b._id,id:b.id,msg:JSON.stringify(b),channel:e})}d(a,b)},removeMessage:function(a,b,c){if(a&&a.messages){var d=a.messages.get(b._id);d&&d.destroy()}c(a,b)}}),c.mixin({tmpl:function(a,b,d){var e,f=/\\|'|\r|\n|\t|\u2028|\u2029/g,g=0;c.uniqueId=function(a){var b=++g+"";return a?a+b:b},c.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var h=/(.)^/,i={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};d=c.defaults({},d,c.templateSettings);var j=new RegExp([(d.escape||h).source,(d.interpolate||h).source,(d.evaluate||h).source].join("|")+"|$","g"),k=0,l=[];l.push("__p+='");var m=d.stickitAttribute||"data-binding";a.replace(j,function(b,c,d,e,g){var h=a.slice(k,g);if(d&&">"===h.slice(-1)){var j=h.slice(0,-1);h=j+" "+m+'="'+d.trim()+'"'+">",l.push(h.replace(f,function(a){return"\\"+i[a]}))}else if(d&&'value="'===h.slice(-7)){var j=h.slice(0,-7);h=j+m+'="'+d.trim()+'" value="',l.push(h.replace(f,function(a){return"\\"+i[a]}))}else l.push(h.replace(f,function(a){return"\\"+i[a]}));return c&&l.push("'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'"),d&&l.push("'+\n((__t=("+d+"))==null?'':__t)+\n'"),e&&l.push("';\n"+e+"\n__p+='"),k=g+b.length,b}),l.push("';\n"),l=l.join(""),d.variable||(l="with(obj||{}){\n"+l+"}\n"),l="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+l+"return __p;\n";try{e=new Function(d.variable||"obj","_",l)}catch(n){throw n.source=l,n}if(b)return e(b,c);var o=function(a){return e.call(this,a,c)};return o.source="function("+(d.variable||"obj")+"){\n"+l+"}",o}}),d.View=b.View.extend(d.Object),d.View.CHILD_VIEW_SELECTOR="data-child-view",c.extend(d.View.prototype,{beforeRender:function(){this.addChildViews()},afterRender:function(){return this.stickit(),this},getTemplateIdentifier:function(){throw console.warn("define your f****ing own getter for the templateIdentifier"),new DOMException},template:c.tmpl('<div id="<%= value %>" contenteditable="true"><div><%= value %></div><div data-child-view="main"></div></div>'),initialize:function(){this._assignTemplate(),this._assignEvents(),this._assignValue(),this._assignContentBinding(),this._assignBinding()},_assignBinding:function(){var a={};c.each(this.model.attributes,function(b,c){var d='[data-binding="'+c+'"]';a[d]={observe:""+c}},this),this.bindings=a},_assignEvents:function(){var a={};c.each(this.events,function(b,d){a[d]={},c.isFunction(b)?a[d]=b:b.action&&c.isFunction(b.action)?a[d]=b.action:b.target&&b.action&&(a[d]=b.target[b.action])},this),this.events=a},_assignContentBinding:function(){if(this.contentBinding&&this.contentBinding.target){var a=this;this.listenTo(this.contentBinding.target,this.contentBinding.property,function(b){a._setValue(b)})}},_assignValue:function(){var a=this.options.value||this.value;c.isFunction(a)&&(a=a()),a instanceof b.Model||a instanceof b.Collection?this._setValue(a,!0):this.model||(this.model=new b.Model({value:a}))},_assignTemplate:function(){if(this.options.template)if(c.isFunction(this.options.template)||c.isNodeList(this.options.template))this.template=this.options.template;else if(c.isObject(this.options.template)){var a=this.getTemplateIdentifier(),b={template:c.extend(d.TemplateManager[a],this.options.template)},e=d.TemplateManager.get.apply(b,["template"]);e?this.template=c.template(e):console.warn("template not found")}},_setValue:function(a,b){this.model=a,b||this.render()},serialize:function(){return this.model?this.model.attributes:{}},applyViews:function(){this.prototype.applyViews.apply(this,arguments)},isView:function(a){return a?d.View.prototype.isPrototypeOf(a):d.View.prototype.isPrototypeOf(this)},addChildViews:function(){var a=this.getChildViews();if(a=this._applyChildViewBinding(a)){var b={};c.each(a,function(a,d){c.isFunction(a)?b[d]=a.create():c.isArray(a)?(b[d]=[],c.each(a,function(a){c.isFunction(a)?b[d].push(a.create()):b[d].push(a)},this)):b[d]=a},this),this.children=b,this.setViews(b)}},_applyChildViewBinding:function(a){if(a){for(var b=new RegExp(d.View.CHILD_VIEW_SELECTOR+'="([a-zA-Z0-9]*)"',"gi"),e=this.template.source||this.template,f=[],g=[];null!==(f=b.exec(e));)g.push(f[1]);var h=a;return 0===c.difference(Object.keys(a),g).length?(h={},c.each(a,function(a,b){var c="["+d.View.CHILD_VIEW_SELECTOR+'="'+b+'"]';h[c]=a},this)):console.warn("found inconsistencies in child views so these are used: ",h),h}},getChildViews:function(){return this.childViews?this.childViews:this.childViews}}),d.View.create=d.create;var e=function(){function a(){f=$("#pt-main"),g=f.children("div.pt-page"),h=$("#iterateEffects"),j=g.length,g.each(function(){var a=$(this);a.data("originalClassList",a.attr("class"))}),g.eq(k).addClass("pt-page-current")}function b(){return l?!1:(i>67&&(i=1),c(i),++i,void 0)}function c(a){if(l)return!1;l=!0;var b=g.eq(k);j-1>k?++k:k=0;var c=g.eq(k).addClass("pt-page-current"),e="",f="";switch(a){case 1:e="pt-page-moveToLeft",f="pt-page-moveFromRight";break;case 2:e="pt-page-moveToRight",f="pt-page-moveFromLeft";break;case 3:e="pt-page-moveToTop",f="pt-page-moveFromBottom";break;case 4:e="pt-page-moveToBottom",f="pt-page-moveFromTop";break;case 5:e="pt-page-fade",f="pt-page-moveFromRight pt-page-ontop";break;case 6:e="pt-page-fade",f="pt-page-moveFromLeft pt-page-ontop";break;case 7:e="pt-page-fade",f="pt-page-moveFromBottom pt-page-ontop";break;case 8:e="pt-page-fade",f="pt-page-moveFromTop pt-page-ontop";break;case 9:e="pt-page-moveToLeftFade",f="pt-page-moveFromRightFade";break;case 10:e="pt-page-moveToRightFade",f="pt-page-moveFromLeftFade";break;case 11:e="pt-page-moveToTopFade",f="pt-page-moveFromBottomFade";break;case 12:e="pt-page-moveToBottomFade",f="pt-page-moveFromTopFade";break;case 13:e="pt-page-moveToLeftEasing pt-page-ontop",f="pt-page-moveFromRight";break;case 14:e="pt-page-moveToRightEasing pt-page-ontop",f="pt-page-moveFromLeft";break;case 15:e="pt-page-moveToTopEasing pt-page-ontop",f="pt-page-moveFromBottom";
break;case 16:e="pt-page-moveToBottomEasing pt-page-ontop",f="pt-page-moveFromTop";break;case 17:e="pt-page-scaleDown",f="pt-page-moveFromRight pt-page-ontop";break;case 18:e="pt-page-scaleDown",f="pt-page-moveFromLeft pt-page-ontop";break;case 19:e="pt-page-scaleDown",f="pt-page-moveFromBottom pt-page-ontop";break;case 20:e="pt-page-scaleDown",f="pt-page-moveFromTop pt-page-ontop";break;case 21:e="pt-page-scaleDown",f="pt-page-scaleUpDown pt-page-delay300";break;case 22:e="pt-page-scaleDownUp",f="pt-page-scaleUp pt-page-delay300";break;case 23:e="pt-page-moveToLeft pt-page-ontop",f="pt-page-scaleUp";break;case 24:e="pt-page-moveToRight pt-page-ontop",f="pt-page-scaleUp";break;case 25:e="pt-page-moveToTop pt-page-ontop",f="pt-page-scaleUp";break;case 26:e="pt-page-moveToBottom pt-page-ontop",f="pt-page-scaleUp";break;case 27:e="pt-page-scaleDownCenter",f="pt-page-scaleUpCenter pt-page-delay400";break;case 28:e="pt-page-rotateRightSideFirst",f="pt-page-moveFromRight pt-page-delay200 pt-page-ontop";break;case 29:e="pt-page-rotateLeftSideFirst",f="pt-page-moveFromLeft pt-page-delay200 pt-page-ontop";break;case 30:e="pt-page-rotateTopSideFirst",f="pt-page-moveFromTop pt-page-delay200 pt-page-ontop";break;case 31:e="pt-page-rotateBottomSideFirst",f="pt-page-moveFromBottom pt-page-delay200 pt-page-ontop";break;case 32:e="pt-page-flipOutRight",f="pt-page-flipInLeft pt-page-delay500";break;case 33:e="pt-page-flipOutLeft",f="pt-page-flipInRight pt-page-delay500";break;case 34:e="pt-page-flipOutTop",f="pt-page-flipInBottom pt-page-delay500";break;case 35:e="pt-page-flipOutBottom",f="pt-page-flipInTop pt-page-delay500";break;case 36:e="pt-page-rotateFall pt-page-ontop",f="pt-page-scaleUp";break;case 37:e="pt-page-rotateOutNewspaper",f="pt-page-rotateInNewspaper pt-page-delay500";break;case 38:e="pt-page-rotatePushLeft",f="pt-page-moveFromRight";break;case 39:e="pt-page-rotatePushRight",f="pt-page-moveFromLeft";break;case 40:e="pt-page-rotatePushTop",f="pt-page-moveFromBottom";break;case 41:e="pt-page-rotatePushBottom",f="pt-page-moveFromTop";break;case 42:e="pt-page-rotatePushLeft",f="pt-page-rotatePullRight pt-page-delay180";break;case 43:e="pt-page-rotatePushRight",f="pt-page-rotatePullLeft pt-page-delay180";break;case 44:e="pt-page-rotatePushTop",f="pt-page-rotatePullBottom pt-page-delay180";break;case 45:e="pt-page-rotatePushBottom",f="pt-page-rotatePullTop pt-page-delay180";break;case 46:e="pt-page-rotateFoldLeft",f="pt-page-moveFromRightFade";break;case 47:e="pt-page-rotateFoldRight",f="pt-page-moveFromLeftFade";break;case 48:e="pt-page-rotateFoldTop",f="pt-page-moveFromBottomFade";break;case 49:e="pt-page-rotateFoldBottom",f="pt-page-moveFromTopFade";break;case 50:e="pt-page-moveToRightFade",f="pt-page-rotateUnfoldLeft";break;case 51:e="pt-page-moveToLeftFade",f="pt-page-rotateUnfoldRight";break;case 52:e="pt-page-moveToBottomFade",f="pt-page-rotateUnfoldTop";break;case 53:e="pt-page-moveToTopFade",f="pt-page-rotateUnfoldBottom";break;case 54:e="pt-page-rotateRoomLeftOut pt-page-ontop",f="pt-page-rotateRoomLeftIn";break;case 55:e="pt-page-rotateRoomRightOut pt-page-ontop",f="pt-page-rotateRoomRightIn";break;case 56:e="pt-page-rotateRoomTopOut pt-page-ontop",f="pt-page-rotateRoomTopIn";break;case 57:e="pt-page-rotateRoomBottomOut pt-page-ontop",f="pt-page-rotateRoomBottomIn";break;case 58:e="pt-page-rotateCubeLeftOut pt-page-ontop",f="pt-page-rotateCubeLeftIn";break;case 59:e="pt-page-rotateCubeRightOut pt-page-ontop",f="pt-page-rotateCubeRightIn";break;case 60:e="pt-page-rotateCubeTopOut pt-page-ontop",f="pt-page-rotateCubeTopIn";break;case 61:e="pt-page-rotateCubeBottomOut pt-page-ontop",f="pt-page-rotateCubeBottomIn";break;case 62:e="pt-page-rotateCarouselLeftOut pt-page-ontop",f="pt-page-rotateCarouselLeftIn";break;case 63:e="pt-page-rotateCarouselRightOut pt-page-ontop",f="pt-page-rotateCarouselRightIn";break;case 64:e="pt-page-rotateCarouselTopOut pt-page-ontop",f="pt-page-rotateCarouselTopIn";break;case 65:e="pt-page-rotateCarouselBottomOut pt-page-ontop",f="pt-page-rotateCarouselBottomIn";break;case 66:e="pt-page-rotateSidesOut",f="pt-page-rotateSidesIn pt-page-delay200";break;case 67:e="pt-page-rotateSlideOut",f="pt-page-rotateSlideIn"}$(b[0]).on(p,function(){b.off(p),m=!0,n&&d(b,c)}),b.addClass(e),$(c[0]).on(p,function(){c.off(p),n=!0,m&&d(b,c)}),c.addClass(f),$(document).on(p,function(){d(b,c)}),q||d(b,c)}function d(a,b){m=!1,n=!1,e(a,b),l=!1}function e(a,b){a.attr("class",a.data("originalClassList")),b.attr("class",b.data("originalClassList")+" pt-page-current")}var f=null,g=null,h=null,i=1,j=0,k=0,l=!1,m=!1,n=!1,o={WebkitAnimation:"webkitAnimationEnd",OAnimation:"oAnimationEnd",msAnimation:"MSAnimationEnd",animation:"animationend"},p=o[Modernizr.prefixed("animation")],q=Modernizr.cssanimations;return{init:a,next:b}}();d.Themes=d.Object.extend({DEFAULT_THEME:"basic",basic:{},_currentThemeName:"basic",_themes:{},registerTemplateForTheme:function(a,b,c,d){d=d||!1;var e=this._getThemeByName(a);e||this._createThemeWithName(a);var f=""!==this._getTemplateByNameForTheme(a,b);return!f||d?(this._themes[a][b]=c,!0):(console.warn('Template "'+b+'" already defined for theme "'+a+'"'),!1)},getTemplateByName:function(a){var b=this.getTemplateByNameForTheme(this._currentThemeName,a);return""==b&&this._currentThemeName!=this.DEFAULT_THEME&&(console.log('Template "'+a+'" not defined for theme "'+this._currentThemeName+'", switched to default theme "'+this.DEFAULT_THEME+'"'),b=this.getTemplateByNameForTheme(this.DEFAULT_THEME,a)),b},getTemplateByNameForTheme:function(a,b){var c=this._getTemplateByNameForTheme(a,b);return c?c:(console.warn('Template "'+b+'" not defined for theme "'+a+'"'),"")},_getTemplateByNameForTheme:function(a,b){var c=this._getThemeByName(a);return c&&c[b]?c[b]:""},_createThemeWithName:function(a){this._themes[a]={}},_getThemeByName:function(a){return this._themes[a]?this._themes[a]:null}}),d.Layout=b.Layout.extend({_type:"M.Layout",isMLayout:YES,template:"<div></div>",applyViews:function(){}}),c.extend(b.Layout.prototype,{transition:null,currentLayout:null,isFirstLoad:!0,_views:null,__totalLayoutViews:null,setTransition:function(){},applyViews:function(a,b){var c=this;this._loadViews(a,function(a){var d=c.currentLayout.__applyViews(a);c.children=d,c.setViews(d),c.render(),b()})},_viewDidLoad:function(a,b,c){this.totalLayoutViews-=1,this._views[a]=b,0===this.totalLayoutViews&&c(this._views)},_loadViews:function(a,b){var d=this;return this.totalLayoutViews=Object.keys(a).length,this._views={},c.each(a,function(a,e){a&&c.isFunction(a)?d._viewDidLoad(e,a.create(),b):a&&"string"==typeof a?require([a],function(a){a.create?d._viewDidLoad(e,a.create(),b):d._viewDidLoad(e,new a,b)}):a&&a.isView()&&d._viewDidLoad(e,a,b)}),this},initialRenderProcess:function(){$("body").html(this.el),e.init()},updateViewport:function(){},navigate:function(a){var d=a.route,e="";a.params&&(e=c.isArray(a.params)?a.params.join("/"):a.params,d+="/");var f=a.options||!0;this.setTransition(a.transition),this.isFirstLoad=!1,b.history.navigate(d+e,f)},setLayout:function(a){return this.currentLayout&&this.currentLayout._type===a._type?this:(this.currentLayout=a,this.el=this.currentLayout.template,this.constructor(this),this.currentLayout.initialize(),this.isFirstLoad=!0,this)},getLayout:function(){return this.currentLayout}}),function(){c.mixin({isNodeList:function(a){return"number"==typeof a.length&&"object"==typeof a[0]&&a[0].hasOwnProperty("innerHTML")?!0:!1}}),d.TemplateManager=d.Object.extend({containerTemplates:{defaultTemplate:'<div><div data-binding="value" contenteditable="true"><%= value %></div><div data-child-view="main"></div>'},buttonTemplates:{defaultTemplate:'<div>Button: <div data-binding="value"<% if(value) {  } %>><%= value %></div></div>',topcoat:'<button class="topcoat-button--large" data-binding="value"><%= value %></button>',bootstrap:'<button type="button" class="btn btn-default btn-lg"> <span class="glyphicon glyphicon-star" data-binding="value"></span><%= value %></button>',jqm:'<a href="#" data-role="button" data-corners="true" data-shadow="true" data-iconshadow="true" data-wrapperels="span" data-theme="c" class="ui-btn ui-shadow ui-btn-corner-all ui-btn-up-c"><span class="ui-btn-inner"><span class="ui-btn-text" data-binding="value"><%= value %></span></span></a>'},toolbarTemplates:{defaultTemplate:'<div>AAA<div data-child-view="left"></div> <div class="center" data-binding="value"><%= value %></div> <div data-child-view="right"></div></div>',bootstrap:'<div class="page-header"><div data-child-view="left"></div><h1><%= value %></h1><div data-child-view="right"></div></div>',jqm:'<div data-role="header" class="ui-header ui-bar-a" role="banner"><div data-child-view="left" class="ui-btn-left"></div><h1 class="ui-title" role="heading" aria-level="1"><%= value %></h1><div data-child-view="right" class="ui-btn-right"></div></div>'},currentTemplate:"jqm",get:function(a){if(this[a]){var b=this[a][d.TemplateManager.currentTemplate];return b?b:this[a].defaultTemplate}}}),d.Button=d.View.extend({_type:"M.Button",initialize:function(){d.View.prototype.initialize.apply(this,arguments)},afterRender:function(){d.View.prototype.afterRender.apply(this,arguments)},contenteditable:!0,template:c.template(d.TemplateManager.get("buttonTemplates"))}),d.Toolbar=d.View.extend({_type:"M.Toolbar",template:c.template(d.TemplateManager.get("toolbarTemplates")),getTemplateIdentifier:function(){return"toolbarTemplates"},initialize:function(){d.View.prototype.initialize.apply(this,arguments)}}),d.ContainerView=d.View.extend({_type:"M.ContainerView",template:c.template(d.TemplateManager.get("containerTemplates"))}),d.Controller=function(){c.extend(this,arguments[0]),this.initialize(arguments[0])},d.Controller.create=d.create,c.extend(d.Controller.prototype,b.Events,{_type:"M.Controller",initialize:function(){return this},set:function(a,b){this[a]=b,this.trigger(a,b)}}),d.ListView=d.View.extend({template:c.template("<div></div>"),initialize:function(){d.View.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"add",this.addOne),this.listenTo(this.model,"fetch",this.addAll);var a=this;this.listenToOnce(this.model,"sync",function(){a.render()}),this.addAll.apply(this)},serialize:function(){return this},addEntry:function(){app.layoutManager.navigate({route:"add"})},addChildViews:function(){},addAll:function(){c.each(this.model.models,function(a){this.addOne.apply(this,[a,!0])},this)},addOne:function(a,b){var c=this.listItemView.create({template:this.listItemView.template,value:a}),d=this.insertView(c);b!==!1&&d.render()}}),d.Router=b.Router.extend({visitedRoutes:{},initialize:function(){this.bootstrap()},bootstrap:function(){FastClick.attach(document.body),$(document).on("click",'a[href^="#"]',function(a){return a.preventDefault(),a.stopPropagation(),void 0}),window[window.TMP_APPLICATION_NAME].layoutManager=new(b.Layout.extend())},controllerDidLoad:function(a,b,c){var d=this.getCallBack(a);d&&d.apply(this,[b]),c()},callCallback:function(a,b,e,f,g){var h=this;return c.isString(e)?require([e],function(a){h.controllerDidLoad(a,f,g)}):d.Controller.prototype.isPrototypeOf(e)&&setTimeout(function(){h.controllerDidLoad(e,f,g)},0),this},getCallBack:function(a){var b=null;return b=0===Object.keys(this.visitedRoutes).length?a.applicationStart:a.show},route:function(a,d,e){c.isRegExp(a)||(a=this._routeToRegExp(a)),c.isFunction(d)&&(e=d,d=""),e||(e=this[d]);var f=this;return b.history.route(a,function(g){var h=null;c.each(f.routes,function(b,c){var d=a.toString().slice(1,-1),e=new RegExp(d.replace(/\(\[\^/g,":([^")),f=e.exec(c);f&&f.length&&(h=f.slice(1))});var i=f._extractParameters(a,g);h=c.object(h,i),i.unshift(!f.visitedRoutes[d]),f.callCallback(a,d,e,h,function(){f.trigger.apply(f,["route:"+d].concat(i)),f.trigger("route",d,i),b.history.trigger("route",f,d,i),f.visitedRoutes[d]||(f.visitedRoutes[d]=!0)})}),this}}),d.Router.create=d.create}(),d.Themes.registerTemplateForTheme(d.Themes.DEFAULT_THEME,"header-layout",'<div class="header"></div>'),d.HeaderLayout=d.Layout.extend({_type:"header-layout",template:d.Themes.getTemplateByName("header-layout")}),d.Themes.registerTemplateForTheme(d.Themes.DEFAULT_THEME,"bottom-bar-layout",'<div class="bottom-bar"></div>'),d.BottomBarLayout=d.Layout.extend({_type:"bottom-bar-layout",template:d.Themes.getTemplateByName("bottom-bar-layout")}),d.Themes.registerTemplateForTheme(d.Themes.DEFAULT_THEME,"switch-layout",'<div id="pt-main" class="pt-perspective"> <div class="pt-page pt-page-1"> <div class="content"></div> <div class="footer"></div> </div> <div class="pt-page pt-page-2"> <div class="content"></div> <div class="footer"></div> </div> </div>'),d.SwitchLayout=d.Layout.extend({_type:"switch-layout",template:d.Themes.getTemplateByName("switch-layout"),currentPage:"",applyViews:function(a){var b=$(".pt-page-current");$(".pt-page:not(.pt-page-current)");var c="";b.length<1?c="pt-page-1":b.hasClass("pt-page-1")?c="pt-page-2":b.hasClass("pt-page-2")&&(c="pt-page-1");var e={};return e["."+c+" .content"]=a.content,e["."+c+" .footer"]=a.footer?a.footer.create():new d.View,e["."+c+" .header"]=a.header?a.header.create():new d.View,e}});var f=$('<div class="wrap"> <div class="left-panel firstLeft"> <div class="action-menu-close"></div> <div class="content"></div> </div> <div class="right-panel"> <div class="content"></div> </div> </div>');return f.find(".right-panel").before(d.SwitchLayout.prototype.template),d.Themes.registerTemplateForTheme(d.Themes.DEFAULT_THEME,"swipe-layout",f),d.SwipeLayout=d.SwitchLayout.extend({_type:"swipe-layout",template:d.Themes.getTemplateByName("swipe-layout"),leftPanelIsOpen:null,rightThreshold:null,initialize:function(){d.SwitchLayout.prototype.initialize.call(this);var a=$(window).width();this.rightThreshold=80*(a/100)},toggleRightPanel:function(){this.closeLeftPanel(),$(".right-panel").toggleClass("show")},closeRightPanel:function(){$(".right-panel").removeClass("show")},toggleLeftPanel:function(){this.closeRightPanel(),this.leftPanelIsOpen?this.closeLeftPanel():this.openLeftPanel()},startMoveLeftPanel:function(a){if(a&&a.originalEvent){a.stopPropagation(),a.preventDefault();var b=a.originalEvent.touches[0]||a.originalEvent.changedTouches[0];this.moveStart=this.leftPanelIsOpen?0:b.pageX}},stopMoveLeftPanel:function(a){a.stopPropagation(),a.preventDefault(),$("#pt-main").addClass("easing"),this.leftPanelIsOpen?this.closeLeftPanel():this.openLeftPanel(),setTimeout(function(){$("#pt-main").removeClass("easing")},500)},moveLeftPanel:function(a){var b=a.originalEvent.touches[0]||a.originalEvent.changedTouches[0],c=b.pageX-this.moveStart;0>=c?c=0:c>=this.rightThreshold?c=this.rightThreshold:$("#pt-main").css("-webkit-transform","translate3d("+c+"px, 0, 0)")},closeLeftPanel:function(){$("#pt-main").css("-webkit-transform","translate3d(0px, 0, 0)"),this.leftPanelIsOpen=!1},openLeftPanel:function(){$("#pt-main").css("-webkit-transform","translate3d("+this.rightThreshold+"px, 0, 0)"),this.leftPanelIsOpen=!0}}),d}(this,Backbone,_);
//# sourceMappingURL=tmp2.map