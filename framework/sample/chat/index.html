<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>TMP2 Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="../../modules/libs/jquery-2.0.0.min.js"></script>
    <script>

        var DATA = {};
        var chat = null;
        var name = null;
        var host = document.location.host;

        function addText(time, name, message, color) {
            var timeStr = new Date(time).toLocaleTimeString();
            var msg  = $('<div/>').text(message).html();
            var text = '<pre>' + timeStr + " - " + (name ? name + ": " : "") + msg + '</pre>';
            $('#chat').append(text);
            $('#chat').scrollTop($('#chat').height());
        }

        $(document).ready(function() {

            name = localStorage.getItem('name') || '';
            name = window.prompt("Wie ist Dein Name?", name) || 'Nobody';

            localStorage.setItem('name', name);

            chat = io.connect('http://' + host + '/chat?name='+name);

            $('#message').on('keypress', function(event) {
                // Enter Key
                if (event.keyCode == 10 || event.keyCode == 13) {
                    event.preventDefault();
                    var msg = $('#message').val();
                    chat.emit('message', {
                        name: name,
                        message: msg,
                        time: new Date().getTime()
                    });
                    $('#message').val('');
                }
            });

            var connected = function (data) {

                addText(new Date().getTime(), '', "Verbindung zum Chat-Server hergestellt.");

                chat.on('message', function (data) {
                    addText(data.time, data.name, data.message);
                });

                chat.on('new-user', function (data) {
                    var message = '"'+ data.name + '" ist beigetreten.';
                    addText(data.time, '', message);
                });

                chat.on('disconnect', function (data) {
                    addText(new Date().getTime(), '', "Die Verbindung wurde getrennt.");
                    chat.removeAllListeners();
                    chat.on('connected', connected);
                });
            };

            chat.on('connected', connected);

        });

    </script>
    <script src="/contact?var=DATA.Contacts"></script>
    </head>
    <body>
        <div id="chat" style="background-color: gray; width:80%; height:400px; overflow-y:auto; -webkit-overflow-scrolling: touch;"></div>
        <input id="message" type="text" style="width:80%;">
    </body>
</html>