<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>The-M-Project Absinthe Source: data/stores/bikini_store.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/shCore.css">
	<link type="text/css" rel="stylesheet" href="styles/shCoreDefault.css">
	<link type="text/css" rel="stylesheet" href="styles/shThemeDefault.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.mway.css">
	

</head>

<body>

<div class="container-fluid">

    <div class="header">
        <a class="logo-container" href="index.html"><img class="logo"  src="img/logo_small.png" alt="The-M-Docs" onclick="loadArticle('home');"></a>
        <div id="searchBar">
            <span class="searchLabel">
                Search:
            </span>
            <input type="text" name="search" id="search" autocomplete="off">
            <!--<input type="button" name="searchButton" id="searchButton" value="search" />-->

        </div>
    </div>

    <div id="search-wrapper">

    </div>

	<div class="affix navbar-inverse">
		<div class="left-panel">
			<ul class="category-list">
			    
				
				<li class="panel-category open">
					<a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials</a>

					<ul class="panel-items open ">
						
						<li>
							<a href="tutorial-Generator.html">Generator</a>
						</li>
						
						<li>
							<a href="tutorial-Sample-Apps.html">Sample-Apps</a>
						</li>
						

					</ul>
				</li>
				
				<li class="panel-category open">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules</a>

					<ul class="panel-items open ">
						
						<li>
							<a href="AddCssClass.html">AddCssClass</a>
						</li>
						
						<li>
							<a href="Animation.html">Animation</a>
						</li>
						
						<li>
							<a href="Application.html">Application</a>
						</li>
						
						<li>
							<a href="Base64.html">Base64</a>
						</li>
						
						<li>
							<a href="BikiniStore.html">BikiniStore</a>
						</li>
						
						<li>
							<a href="BottomBarLayout.html">BottomBarLayout</a>
						</li>
						
						<li>
							<a href="ButtonGroupView.html">ButtonGroupView</a>
						</li>
						
						<li>
							<a href="ButtonView.html">ButtonView</a>
						</li>
						
						<li>
							<a href="CheckboxlistView.html">CheckboxlistView</a>
						</li>
						
						<li>
							<a href="Collection.html">Collection</a>
						</li>
						
						<li>
							<a href="CONST.html">CONST</a>
						</li>
						
						<li>
							<a href="Controller.html">Controller</a>
						</li>
						
						<li>
							<a href="Cypher.html">Cypher</a>
						</li>
						
						<li>
							<a href="DataSelector.html">DataSelector</a>
						</li>
						
						<li>
							<a href="Date.html">Date</a>
						</li>
						
						<li>
							<a href="DebugView.html">DebugView</a>
						</li>
						
						<li>
							<a href="DialogView.html">DialogView</a>
						</li>
						
						<li>
							<a href="Entity.html">Entity</a>
						</li>
						
						<li>
							<a href="Environment.html">Environment</a>
						</li>
						
						<li>
							<a href="Field.html">Field</a>
						</li>
						
						<li>
							<a href="HeaderLayout.html">HeaderLayout</a>
						</li>
						
						<li>
							<a href="I18N.html">I18N</a>
						</li>
						
						<li>
							<a href="I18NItem.html">I18NItem</a>
						</li>
						
						<li>
							<a href="ImageView.html">ImageView</a>
						</li>
						
						<li>
							<a href="Interface.html">Interface</a>
						</li>
						
						<li>
							<a href="Layout.html">Layout</a>
						</li>
						
						<li>
							<a href="ListItemView.html">ListItemView</a>
						</li>
						
						<li>
							<a href="ListView.html">ListView</a>
						</li>
						
						<li>
							<a href="Loader.html">Loader</a>
						</li>
						
						<li>
							<a href="LoaderView.html">LoaderView</a>
						</li>
						
						<li>
							<a href="LocalStorageStore.html">LocalStorageStore</a>
						</li>
						
						<li>
							<a href="Logger.html">Logger</a>
						</li>
						
						<li>
							<a href="ModalView.html">ModalView</a>
						</li>
						
						<li>
							<a href="Model.html">Model</a>
						</li>
						
						<li>
							<a href="Object.html">Object</a>
						</li>
						
						<li>
							<a href="ObjectID.html">ObjectID</a>
						</li>
						
						<li>
							<a href="PageTransitions.html">PageTransitions</a>
						</li>
						
						<li>
							<a href="RadiolistView.html">RadiolistView</a>
						</li>
						
						<li>
							<a href="Request.html">Request</a>
						</li>
						
						<li>
							<a href="RequestManager.html">RequestManager</a>
						</li>
						
						<li>
							<a href="Router.html">Router</a>
						</li>
						
						<li>
							<a href="SearchfieldView.html">SearchfieldView</a>
						</li>
						
						<li>
							<a href="SelectionlistView.html">SelectionlistView</a>
						</li>
						
						<li>
							<a href="SelectView.html">SelectView</a>
						</li>
						
						<li>
							<a href="SHA256.html">SHA256</a>
						</li>
						
						<li>
							<a href="SliderView.html">SliderView</a>
						</li>
						
						<li>
							<a href="SocketIO.html">SocketIO</a>
						</li>
						
						<li>
							<a href="SqlSelector.html">SqlSelector</a>
						</li>
						
						<li>
							<a href="Store.html">Store</a>
						</li>
						
						<li>
							<a href="SwipeLayout.html">SwipeLayout</a>
						</li>
						
						<li>
							<a href="SwitchLayout.html">SwitchLayout</a>
						</li>
						
						<li>
							<a href="TabLayout.html">TabLayout</a>
						</li>
						
						<li>
							<a href="TabView.html">TabView</a>
						</li>
						
						<li>
							<a href="TemplateManager.html">TemplateManager</a>
						</li>
						
						<li>
							<a href="TextareaView.html">TextareaView</a>
						</li>
						
						<li>
							<a href="TextfieldView.html">TextfieldView</a>
						</li>
						
						<li>
							<a href="TextView.html">TextView</a>
						</li>
						
						<li>
							<a href="Themes.html">Themes</a>
						</li>
						
						<li>
							<a href="Toast.html">Toast</a>
						</li>
						
						<li>
							<a href="ToggleSwitchView.html">ToggleSwitchView</a>
						</li>
						
						<li>
							<a href="ToggleView.html">ToggleView</a>
						</li>
						
						<li>
							<a href="ToolbarView.html">ToolbarView</a>
						</li>
						
						<li>
							<a href="UniqueId.html">UniqueId</a>
						</li>
						
						<li>
							<a href="View.html">View</a>
						</li>
						
						<li>
							<a href="ViewEnableState.html">ViewEnableState</a>
						</li>
						
						<li>
							<a href="ViewManager.html">ViewManager</a>
						</li>
						
						<li>
							<a href="WebSqlStore.html">WebSqlStore</a>
						</li>
						

					</ul>
				</li>
				
				<li class="panel-category open">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes</a>

					<ul class="panel-items open ">
						
						<li>
							<a href="M.Config.html">Config</a>
						</li>
						
						<li>
							<a href="M.Entity.html">Entity</a>
						</li>
						
						<li>
							<a href="Controller-M.Controller.html">Controller</a>
						</li>
						
						<li>
							<a href="Field-M.Field.html">Field</a>
						</li>
						
						<li>
							<a href="View-constructor.html">constructor</a>
						</li>
						

					</ul>
				</li>
				
				<li class="panel-category open">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global</a>

					<ul class="panel-items open ">
						
						<li>
							<a href="global.html#_registerActiveState">_registerActiveState</a>
						</li>
						
						<li>
							<a href="global.html#_type">_type</a>
						</li>
						
						<li>
							<a href="global.html#applyViews">applyViews</a>
						</li>
						
						<li>
							<a href="global.html#get">get</a>
						</li>
						
						<li>
							<a href="global.html#getInterface">getInterface</a>
						</li>
						
						<li>
							<a href="global.html#M">M</a>
						</li>
						
						<li>
							<a href="global.html#NO">NO</a>
						</li>
						
						<li>
							<a href="global.html#template">template</a>
						</li>
						
						<li>
							<a href="global.html#YES">YES</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


        <span id="toc0" class="toc-shim"></span>
		<h1 class="page-title">Source: data/stores/bikini_store.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">// Copyright (c) 2013 M-Way Solutions GmbH
// http://github.com/mwaylabs/The-M-Project/blob/absinthe/MIT-LICENSE.txt

/**
 *
 * @module M.BikiniStore
 *
 * @type {*}
 * @extends M.Store
 */
M.BikiniStore = M.Store.extend({

    _type: 'M.BikiniStore',

    _transactionFailed: false,

    _selector: null,

    endpoints: {},

    options: null,

    localStore: M.WebSqlStore,

    useLocalStore: true,

    useSocketNotify: true,

    useOfflineChanges: true,

    typeMapping: {
        'binary': 'text',
        'date': 'string'
    },

    initialize: function( options ) {
        M.Store.prototype.initialize.apply(this, arguments);
        this.options = this.options || {};
        this.options.useLocalStore = this.useLocalStore;
        this.options.useSocketNotify = this.useSocketNotify;
        this.options.useOfflineChanges = this.useOfflineChanges;
        this.options.socketPath = this.socketPath;
        this.options.localStore = this.localStore;
        this.options.typeMapping = this.typeMapping;
        _.extend(this.options, options || {});
    },

    initModel: function( model ) {
    },

    initCollection: function( collection ) {
        var url = collection.getUrlRoot();
        var entity = this.getEntity(collection.entity);
        if( url && entity ) {
            var name = entity.name;
            var idAttribute = entity.idAttribute;
            var hash = this._hashCode(url);
            var credentials = entity.credentials || collection.credentials;
            var user = credentials && credentials.username ? credentials.username : '';
            var channel = name + user + hash;
            collection.channel = channel;
            // get or create endpoint for this url
            var that = this;
            var endpoint = this.endpoints[hash];
            if( !endpoint ) {
                var href = M.Request.getLocation(url);
                endpoint = {};
                endpoint.baseUrl = url;
                endpoint.readUrl = collection.getUrl();
                endpoint.host = href.protocol + '//' + href.host;
                endpoint.path = href.pathname;
                endpoint.entity = entity;
                endpoint.channel = channel;
                endpoint.credentials = credentials;
                endpoint.socketPath = this.options.socketPath;
                endpoint.localStore = this.createLocalStore(endpoint);
                endpoint.messages = this.createMsgCollection(endpoint);
                endpoint.socket = this.createSocket(endpoint, collection);
                endpoint.info = this.fetchServerInfo(endpoint, collection);
                that.endpoints[hash] = endpoint;
            }
            collection.endpoint = endpoint;
            collection.listenTo(this, endpoint.channel, this.onMessage, collection);
            if( endpoint.messages && !endpoint.socket ) {
                that.sendMessages(endpoint, collection);
            }
        }
    },

    getEndpoint: function( url ) {
        if( url ) {
            var hash = this._hashCode(url);
            return this.endpoints[hash];
        }
    },

    createLocalStore: function( endpoint, idAttribute ) {
        if( this.options.useLocalStore && endpoint ) {
            var entities = {};
            entities[endpoint.entity.name] = {
                name: endpoint.channel,
                idAttribute: idAttribute
            };
            return new this.options.localStore({
                entities: entities
            });
        }
    },

    createMsgCollection: function( endpoint ) {
        if( this.options.useOfflineChange && endpoint ) {
            var name = 'msg-' + endpoint.channel;
            var MsgCollection = M.Collection.extend({
                model: M.Model.extend({ idAttribute: '_id' })
            });
            var messages = new MsgCollection({
                entity: name,
                store: new this.options.localStore()
            });
            messages.fetch();
            return messages;
        }
    },

    createSocket: function( endpoint, collection, name ) {
        if( this.options.useSocketNotify && endpoint.socketPath && endpoint ) {
            var path = endpoint.path;
            path = endpoint.socketPath || (path + (path.charAt(path.length - 1) === '/' ? '' : '/' ) + 'live');
            // remove leading /
            var resource = (path && path.indexOf('/') === 0) ? path.substr(1) : path;
            var that = this;
            var socket = M.SocketIO.create({
                host: endpoint.host,
                resource: resource,
                connected: function() {
                    that._bindChannel(socket, endpoint, name);
                    that.sendMessages(endpoint, collection);
                }
            });
            return socket;
        }
    },

    _bindChannel: function( socket, endpoint, name ) {
        var that = this;
        var channel = endpoint.channel;
        var time = this.getLastMessageTime(channel);
        name = name || endpoint.entity.name;
        socket.on(channel, function( msg ) {
            if( msg ) {
                that.setLastMessageTime(channel, msg.time);
                that.trigger(channel, msg);
            }
        });
        socket.emit('bind', {
            entity: name,
            channel: channel,
            time: time
        });
    },

    getLastMessageTime: function( channel ) {
        return localStorage.getItem('__' + channel + 'last_msg_time') || 0;
    },

    setLastMessageTime: function( channel, time ) {
        if( time ) {
            localStorage.setItem('__' + channel + 'last_msg_time', time);
        }
    },

    _hashCode: function( str ) {
        var hash = 0, char;
        if( str.length === 0 ) {
            return hash;
        }
        for( var i = 0, l = str.length; i &lt; l; i++ ) {
            char = str.charCodeAt(i);
            hash = ((hash &lt;&lt; 5) - hash) + char;
            hash |= 0; // Convert to 32bit integer
        }
        return hash;
    },

    onMessage: function( msg ) {
        if( msg && msg.method ) {
            var localStore = this.endpoint ? this.endpoint.localStore : null;
            var options = { store: localStore, merge: true, fromMessage: true, entity: this.entity, parse: true };
            var attrs = msg.data;

            switch( msg.method ) {
                case 'patch':
                case 'update':
                case 'create':
                    options.patch = msg.method === 'patch';
                    var model = msg.id ? this.get(msg.id) : null;
                    if( model ) {
                        model.save(attrs, options);
                    } else {
                        this.create(attrs, options);
                    }
                    break;
                case 'delete':
                    if( msg.id ) {
                        if( msg.id === 'all' ) {
                            while((model = this.first())) {
                                if( localStore ) {
                                    localStore.sync.apply(this, ['delete', model, { store: localStore, fromMessage: true } ]);
                                }
                                this.remove(model);
                            }
                            this.store.setLastMessageTime(this.endpoint.channel, '');
                        } else {
                            var msgModel = this.get(msg.id);
                            if( msgModel ) {
                                msgModel.destroy(options);
                            }
                        }
                    }
                    break;

                default:
                    break;
            }
        }
    },

    sync: function( method, model, options ) {
        var that = options.store || this.store;
        if( options.fromMessage ) {
            return that.handleCallback(options.success);
        }
        var endpoint = that.getEndpoint(this.getUrlRoot());
        if( that && endpoint ) {
            var channel = this.channel;

            if( M.isModel(model) && !model.id ) {
                model.set(model.idAttribute, new M.ObjectID().toHexString());
            }

            var time = that.getLastMessageTime(channel);
            // only send read messages if no other store can do this
            // or for initial load
            if( method !== 'read' || !endpoint.localStore || !time ) {
                // do backbone rest
                that.addMessage(method, model, // we don't need to call callbacks if an other store handle this
                    endpoint.localStore ? {} : options, endpoint);
            } else if( method === 'read' && time ) {
                that.fetchChanges(endpoint, time);
            }
            if( endpoint.localStore ) {
                options.store = endpoint.localStore;
                endpoint.localStore.sync.apply(this, arguments);
            }
        }
    },

    addMessage: function( method, model, options, endpoint ) {
        var that = this;
        if( method && model ) {
            var changes = model.changedSinceSync;
            var data = null;
            var storeMsg = false;
            switch( method ) {
                case 'update':
                case 'create':
                    data = options.attrs || model.toJSON();
                    storeMsg = true;
                    break;
                case 'patch':
                    if( _.isEmpty(changes) ) {
                        return;
                    }
                    data = model.toJSON({ attrs: changes });
                    storeMsg = true;
                    break;
                case 'delete':
                    storeMsg = true;
                    break;
            }
            var msg = {
                _id: model.id,
                id: model.id,
                method: method,
                data: data
            };
            var emit = function( endpoint, msg ) {
                that.emitMessage(endpoint, msg, options, model);
            };
            if( storeMsg ) {
                this.storeMessage(endpoint, msg, emit);
            } else {
                emit(endpoint, msg);
            }
        }
    },

    emitMessage: function( endpoint, msg, options, model ) {
        var channel = endpoint.channel;
        var that = this;
        var url = M.isModel(model) || msg.method !== 'read' ? endpoint.baseUrl : endpoint.readUrl;
        if( msg.id && msg.method !== 'create' ) {
            url += '/' + msg.id;
        }
        model.sync.apply(model, [msg.method, model, {
            url: url,
            error: function( xhr, status ) {
                if( !xhr.responseText && that.options.useOfflineChange ) {
                    // this seams to be only a connection problem, so we keep the message an call success
                    that.handleCallback(options.success, msg.data);
                } else {
                    that.removeMessage(endpoint, msg, function( endpoint, msg ) {
                        // Todo: revert changed data
                        that.handleCallback(options.error, status);
                    });
                }
            },
            success: function( data ) {
                that.removeMessage(endpoint, msg, function( endpoint, msg ) {
                    if( options.success ) {
                        var resp = data;
                        that.handleCallback(options.success, resp);
                    } else {
                        // that.setLastMessageTime(channel, msg.time);
                        if( msg.method === 'read' ) {
                            var array = _.isArray(data) ? data : [ data ];
                            for( var i = 0; i &lt; array.length; i++ ) {
                                data = array[i];
                                if( data ) {
                                    that.trigger(channel, {
                                        id: data._id,
                                        method: 'update',
                                        data: data
                                    });
                                }
                            }
                        } else {
                            that.trigger(channel, msg);
                        }
                    }
                });
            },
            store: {}
        }]);
    },

    fetchChanges: function( endpoint, time ) {
        var that = this;
        if( endpoint && endpoint.baseUrl && time ) {
            var changes = new M.Collection({});
            changes.fetch({
                url: endpoint.baseUrl + '/changes/' + time,
                success: function() {
                    changes.each(function( msg ) {
                        if( msg.time && msg.method ) {
                            that.setLastMessageTime(endpoint.channel, msg.time);
                            that.trigger(endpoint.channel, msg);
                        }
                    });
                },
                credentials: endpoint.credentials
            });
        }
    },

    fetchServerInfo: function( endpoint, collection ) {
        var that = this;
        if( endpoint && endpoint.baseUrl ) {
            var info = new M.Model();
            var time = that.getLastMessageTime(endpoint.channel);
            info.fetch({
                url: endpoint.baseUrl + '/info',
                success: function() {
                    if( !time && info.get('time') ) {
                        that.setLastMessageTime(endpoint.channel, info.get('time'));
                    }
                    if( !endpoint.socketPath && info.get('socketPath') ) {
                        endpoint.socketPath = info.get('socketPath');
                        var name = info.get('entity') || endpoint.entity.name;
                        if( that.options.useSocketNotify ) {
                            that.createSocket(endpoint, collection, name);
                        }
                    }
                },
                credentials: endpoint.credentials
            });
        }
    },

    sendMessages: function( endpoint, collection ) {
        if( endpoint && endpoint.messages && collection ) {
            var that = this;
            endpoint.messages.each(function( message ) {
                var msg;
                try {
                    msg = JSON.parse(message.get('msg'));
                } catch( e ) {
                }
                var channel = message.get('channel');
                if( msg && channel ) {
                    var model = that.createModel({ collection: collection }, msg.data);
                    that.emitMessage(endpoint, msg, {}, model);
                } else {
                    message.destroy();
                }
            });
        }
    },

    mergeMessages: function( data, id ) {
        return data;
    },

    storeMessage: function( endpoint, msg, callback ) {
        if( endpoint && endpoint.messages && msg ) {
            var channel = endpoint.channel;
            var message = endpoint.messages.get(msg._id);
            if( message ) {
                var oldMsg = JSON.parse(message.get('msg'));
                message.save({
                    msg: JSON.stringify(_.extend(oldMsg, msg))
                });
            } else {
                endpoint.messages.create({
                    _id: msg._id,
                    id: msg.id,
                    msg: JSON.stringify(msg),
                    channel: channel
                });
            }
        }
        callback(endpoint, msg);
    },

    removeMessage: function( endpoint, msg, callback ) {
        if( endpoint && endpoint.messages ) {
            var message = endpoint.messages.get(msg._id);
            if( message ) {
                message.destroy();
            }
        }
        callback(endpoint, msg);
    },

    clear: function( collection ) {
        if( collection ) {
            var endpoint = this.getEndpoint(collection.getUrlRoot());
            if( endpoint ) {
                if( endpoint.localStore ) {
                    endpoint.localStore.destroy();
                }
                if( endpoint.messages ) {
                    endpoint.messages.destroy();
                }
                collection.reset();
                this.setLastMessageTime(endpoint.channel, '');
            }
        }
    }

});
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		DocStrap Copyright © 2012-2013 The contributors to the JSDoc3 and DocStrap projects.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a>
		on Wed Dec 04 2013 10:24:26 GMT+0100 (CET) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/toggle-menu.js"></script>
	<script src="scripts/toc.js"></script>
	<script src="scripts/search.js"></script>

	<script type="text/javascript" src="scripts/shCore.js"></script>
	<script type="text/javascript" src="scripts/shBrushJScript.js"></script>
	<link type="text/css" rel="stylesheet" href="styles/shCoreDefault.css"/>
	<script type="text/javascript">SyntaxHighlighter.all();</script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
